<!DOCTYPE html>

<head>
    <meta charset="UTF-8">
    <title>舟山中远NCR--手机</title>
    <link rel='stylesheet' href="index.css" />
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=yes" />
</head>

<body>
    <!--登录页-->
    <div id="_start" style="left: 350px; height: 100%; overflow:hidden;width: 100%;">
        <div style="margin: 0 5px"> </div>
        <div id="login_container" style="display: block;">
            <div id="lab1">
                <span id="lab_login" style="text-align: center">NCR-用户登录</span>
            </div>
            <div style="width:330px;">
                <span id="lab_type1">账号+密码登陆</span>
            </div>
            <div id="form_container1">
                <br>
                <input type="text" class="form-control" placeholder="用户名" id="login_number">
                <input type="password" class="form-control" placeholder="密码" id="login_password">
                <input type="button" value="登录" class="btn btn-success" id="login_btn">
            </div>
        </div>
    </div>
    
    <div class="title">
        <div class="rollback header_btn">返回</div>
        <div class="header_title">舟山中远NCR</div>
        <div class='loginout header_btn'>退出</div>
    </div>

    <div id="info" style="display: none;position: absolute;left:0;top: 40px;">
        <div id="tableData">
            <!--列表页-->
            <!-- <div id='tableinfo' style="padding: 5px">
                <div style="margin-bottom: 10px"></div>
                <input id='filter_input' style="width:70%;height:100%;display: inline" type="text" class="form-control" placeholder="输入过滤条件">
                <span id='filter_data' class="btn btn-default" style="width:15%">过滤</span>
            </div> -->
            <table id='mytable' style="clear: both" class="table table-bordered table-striped table-responsive">
                <thead>
                </thead>
                <tbody>
                </tbody>
            </table>

            <div class="moredata">
                加载更多数据
            </div>
        </div>
    </div>

    <!-- 搜索页 -->
    <div class="modal" id='searchModel' style="position: absolute;left:0;top: 40px;">
        <table style="width:100%;">
            <tr>
                <td width="80">
                    <label for='shipno'>船号</label>
                </td>
                <td colspan="3">
                    <select class="form-control" id='shipno'>
                    </select>
                </td>
            </tr>
            <tr>
                <td>
                    <label for='checkplace'>责任工区</label>
                </td>
                <td colspan="3">
                    <select class="form-control selectpicker" id='checkplace'>
                    </select>
                </td>

            </tr>
            <tr style="display:none;">
                <td>
                    <label for='checkplace'>报验人</label>
                </td>
                <td colspan="3">
                    <select class="form-control selectpicker" id='checker'>
                    </select>
                </td>

            </tr>
            
        </table>


        <button type="button" class="btn btn-primary" id="searchBtn" style="width: 100px;float: right">搜索</button>
    </div>


    <!--详情页-->
    <div id="detailV" style="display: none">
        <div class="title">
            <div class="rollback header_btn">返回</div>
            <div class="header_title">NCR详情</div>
            <div class='loginout header_btn'>退出</div>
        </div>
        <table id="detail" width="100%" class='table table-responsive table-striped' style="border-collapse: separate;">
        </table>
    </div>

    <!-- 消息 -->
    <div id="loading" class="loading load_img">加载中...</div>
    <div id='notice' class="loading"></div>

</body>
<script src="jquery.js"></script>
<script type="text/javascript">
    var showH = [
            "编号", 
            "船号",
            "日期",
            "Subject",
            "工区",
            "状态" 
        ],
        keys = [
            "No",
            "ShipNo",
            "Date",
            "Subject",
            "Reason",
            "Status" 
        ],
        table = $("#mytable"),
        currentData = [];
    page = 20;
    table.data("tableData", []);

    function oneLine(cell) {
        var str = [];
        showH.forEach(function (key) {
            str.push(cell[key]);
        });
        return str.join("$$");
    }

    function _filter(dataStr) {
        if (dataStr == "") {
            return [].concat(table.data("tableData"));
        }

        return table.data("tableData").filter(function (cell) {
            return oneLine(cell).indexOf(dataStr) != -1;
        });
    }

    function theader() {
        var header = table.find("thead");
        header.empty();
        var tr = $("<tr></tr>");
        header.append(tr);

        showH.forEach(function (cell) {
            var th = $("<th></th>");
            th.text(cell);
            tr.append(th);
        });
    }

    function downLoadNCRPDF(name){
        console.log(name);
        DownLoadFile({
            url:'/download/n', //请求的url
            data:{type:8,t1:name}//要发送的数据
        });
    }

    function appendRow(value) {
        var tr = $("<tr></tr>");
        tr.data("rowData", value);

        keys.forEach(function (cell) {
            var td = $("<td></td>");
            if(cell == "No"){
                var url1 = "#"
                if(value["pdf"] != ""){
                    url1 = "./NCR/file/"+value["pdf"]
                   // td.html("<a href='#' onclick='javascript:downLoadNCRPDF(\""+value["No"]+"\")'>"+value["No"]+"</a>");
                     td.html("<a href='"+url1+"' target='_blank'>"+value["No"]+"</a>");
                }else{
                    td.text(value[cell] ? value[cell] : "");
                }
               
            }else{
                td.text(value[cell] ? value[cell] : "");
            }
            tr.append(td);
        });
        return tr;
    }
    var index = 1;

    function tableF(values, refresh) {
        var tbody = $("#mytable").find("tbody");
        if (refresh) {
            tbody.empty();
            index = 1;
        }
        if (values.length >= page) {
            var add = values.splice(0, page);
        } else {
            var add = values.splice(0, values.length);
        }
        add.forEach(function (cell) {

            cell["序号"] = index++;
            tbody.append(appendRow(cell));
        });

        // tbody.find("tr").click(function (e) {
        //     var data = $(e.target.parentElement).data("rowData");
        //     showInfo(data)
        // });
        if (values.length > 0) {
            $(".moredata").show(100);
        } else {
            $(".moredata").hide(100);
        }
    }

    function genText(_label, value) {
        var group = $("<tr></tr>");
        var label = $("<td width='20%' style='text-align:right'><label>" + _label + ":</label></td>");
        var input = $("<td  width='70%'><div>" + value + "</div></td>");
        group.append(label);
        group.append(input);
        return group;
    }

    //登录页
    function showStep0() {
        $("#_start").show(200);
        $("#info").hide(200);
        // $(".title").hide(200);

        $(".rollback").hide(200);
        $(".loginout").hide(200);
        $(".modal").hide(200);
        $("#info").css("minWidth","400px");
    }
    var currentIndex = 0;
    //搜索页
    function showStep1() {
        currentIndex = 1;
        $(".header_title").text("舟山中远NCR未关闭");
        $("#info").show(200);
        $("#tableData").hide(200);
        $("#searchModel").show(200);
        $(".rollback").hide(200);
        $(".loginout").show(200);

        $("#_start").hide(200);
        $("#detailV").hide(200);
        $("#info").css("minWidth","400px");
    }

    //列表页
    function showStep2() {
        currentIndex = 2;
        $(".header_title").text("舟山中远NCR未关闭");

        $("#info").show(200);
        $("#tableData").show(200);
        $("#searchModel").hide(200);
        $(".rollback").show(200);
        $(".loginout").show(200);

        $("#_start").hide(200);
        $("#detailV").hide(200);
        $("#info").css("minWidth","900px");
    }
    //详情页
    function showStep3() {
        currentIndex = 3;
        $("#_start").hide(200);
        $("#info").hide(200);
        $("#detailV").show(200);
        $(".rollback").show(200);
    }

    function showInfo(value) {
        var detail = $("#detail");
        detail.empty();
        keys.forEach(function (key) {
            detail.append(genText(key, value[key] ? value[key] : ""));
        });
        showStep3();
    }

    function appendOptions(id, values) {
        var select = $("#" + id);
        select.empty();
        values.forEach(function (cell) {
            if(typeof cell == "undefined"){
                return;
            }
            select.append($("<option value='" + cell.v.toString() + "'>" + cell.t.toString() + "</option>"));
        });
    }

    function set(id, flag, container) {
        if (flag) {
            container[id] = $("#" + id).val();
            return;
        }
        $("#" + id).val("");
    }

    function getValue(getV) {
        var ids = ["checkplace", "shipno", "checker"];
        var values = {};
        ids.forEach(function (cell) {
            set(cell, getV, values);
        });
        return values;

    }

    var ConfigParam = {};

    function loadConfigParamShip(cbNext){
        $.getJSON("/ship/getOk", function (data) {
            var arr1 = $(data).map(function () {
                return {
                    v: this.船号,
                    t: this.船号 + ' ' + this.描述
                }
            }).get();
            ConfigParam["船号组"] = arr1;
            typeof cbNext == 'function' && cbNext()
        });
    }

    function loadConfigParamUser(cbNext){
        $.getJSON("/user/get", function (data) {
            var arr2 = $(data).map(function () {
                return {
                    v: this.英文名,
                    t: this.英文名 + '(' + this.名 + ')'
                }
            }).get();
            ConfigParam["用户组"] = arr2;
            typeof cbNext == 'function' && cbNext()
        });
    }

    function loadConfigParam(cb) {
        $.getJSON("/quality/dailyformconfig.json", function (data) {
            $.extend(ConfigParam, data);
            loadConfigParamShip(function cb2(){
                loadConfigParamUser(function cb3(){
                     typeof cb == 'function' && cb(ConfigParam)
                })
            });
            

        });
    }

    function init() {
        loadConfigParam(function (data) {
            appendOptions("checker", [{
                v: "",
                t: ""
            }].concat(data.用户组));
            appendOptions("checkplace", [{
                v: "",
                t: ""
            }].concat($(data.责任工区).map(function () {
                return {
                    v: this,
                    t: this
                }
            }).get()));
            appendOptions("shipno", [{
                v: "",
                t: ""
            }].concat(data.船号组));
        });
    }

    $(function () {
        setTimeout(function () {
            theader();
        }, 1);

        $("#_start").height($(document).height());
        $("#login_btn").click(function () {
            function validate() {
                var user = $("#login_number").val(),
                    pass = $("#login_password").val();
                if (!user) return showInfo("请输入用户名");
                if (!pass) return showInfo("请输入密码");
                return {
                    'name': user,
                    'pass': pass
                }
            }

            var data = validate();
            if (!data) return;

            $('.loginout').text(data.name);
            ajaxUitl("/user/find", JSON.stringify(data), function () {
                $("#login_password").val("");
                init();
                showStep1();
            }, {
                msg: "登录失败,请核对用户名和密码"
            });
        });
        // $('#selDate1,#selDate2').datepicker({
        //     autoclose: true,
        //     language: "zh-CN",
        //     format: 'yyyy-mm-dd',
        // });

        // $("#searchModel").on("hidden.bs.modal", function () {
        //     setTimeout(function () {
        //         getValue(false);
        //     }, 1);
        // });

        function rollback() {
            switch (currentIndex) {
                case 1:
                    showStep0();
                    break
                case 2:
                    getValue(false);
                    showStep1();
                    break;
                default:
                    showStep2();
                    break;
            }
        }

        function showInfo(msg) {
            $("#notice").text(msg);
            $("#notice").show(100);
            setTimeout(function () {
                $("#notice").hide(100);
            }, 2000);
        }

        function ajaxUitl(url, data, success, config) {
            var _config = {
                url: url,
                data: data,
                success: function (data) {
                    $("#loading").hide(100);
                    success(data);
                },
                error: function (data) {
                    $("#loading").hide(100);
                    if (config && config.error) {
                        config.error();
                    } else {
                        showInfo(config && config.msg ? config.msg : "加载数据异常");
                    }
                }
            }
            $.extend(true, _config, config);
            $("#loading").show(100);
            $.ajax(_config);
        }

        $("#searchBtn").click(function () {
            var data = getValue(true);
            
            var filter11 = {};
         
            if (data.shipno != '') {
                filter11["船号"] = data.shipno
            }
            else{
                alert("请选择船号")
                return
            }
            if (data.checkplace != '') {
                filter11["责任工区"] = data.checkplace
            }
            if (data.checker != '') {
                filter11["质检员"] = data.checker
            }
     
            var url = '/ncr/get?filter=' + JSON.stringify(filter11) 

            showStep2();

            ajaxUitl(url, {}, function (data) {
                if (data.length <= 0) {
                    return showInfo("未获取到符合条件的数据");
                }

                currentData = data;
                table.data("tableData", [].concat(currentData));
                tableF(currentData, true);

            })
        });

        $(".loginout").click(function () {
            showStep0();
        });

        $(".rollback").click(function () {
            rollback();
        });

        $(".moredata").click(function () {
            tableF(currentData, false);
        });

        $("#filter_data").click(function () {
            var data = _filter($("#filter_input").val().trim());
            $("#filter_data").css({
                "color": "#333",
                "background-color": "#fff",
                "border-color": "#ccc"
            });
            if (data.length <= 0) {
                return showInfo("未获取到符合条件的数据");
            }
            tableF(data,true);
        });
    });

    var DownLoadFile = function (options) {
        var dconfig = $.extend(true, { method: 'post' }, options);
        var $iframe = $('<iframe id="down-file-iframe" />');
        var $form = $('<form target="down-file-iframe" method="' + dconfig.method + '" />');
        $form.attr('action', dconfig.url);
        for (var key in dconfig.data) {
            $form.append('<input type="hidden" name="' + key + '" value="' + dconfig.data[key] + '" />');
        }
        $iframe.append($form);
        $(document.body).append($iframe);
        $form[0].submit();
        $iframe.remove();
    }
</script>

</html>