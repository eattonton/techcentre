<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>舟山中远海运重工--焊工管理--信息录入</title>
    <link rel="stylesheet" type="text/css" href="js/easyui-1.5.3/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="js/easyui-1.5.3/themes/icon.css">
    <script type="text/javascript" src="js/easyui-1.5.3/jquery.min.js"></script>
    <script type="text/javascript" src="js/easyui-1.5.3/jquery.easyui.min.js"></script>
    <script type="text/javascript" src='js/easyui-1.5.3/locale/easyui-lang-zh_CN.js'></script>

    <script type="text/javascript" src="/WeldStaffWeb/weldstaff/ajax.js"></script>
    <script type="text/javascript" src="/WeldStaffWeb/weldstaff/config.js"></script>
    <script type="text/javascript" src="/WeldStaffWeb/weldstaff/weldform/lodash.js"></script>
    <script type="text/javascript" src="/WeldStaffWeb/weldstaff/weldform/genEasyUI.js"></script>
    <script type="text/javascript" src="/WeldStaffWeb/weldstaff/input.js"></script>
    <script type="text/javascript" src="/WeldStaffWeb/weldstaff/messager.js"></script>
    <style type="text/css">
        * {
            padding: 0px;
            margin: 0px;
        }

        .dialog-row {
            padding: 5px;
            align-items: baseline;
            vertical-align: middle;
        }

        .dialog-mask {
            position: fixed;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            background: #000;
            filter: alpha(opacity=50);
            opacity: .5;
            display: block;
            overflow-x: hidden;
            overflow-y: auto;
        }

        .dlg-tt {
            width: 750px;
            height: 450px;
            border: 1px solid #ddd;
            box-shadow: 0 3px 9px rgba(0, 0, 0, 0.5);
            border-radius: 4px;
            background-color: #fff;
            z-index: 11;
            display: none;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }

        .dlg-tt .dlg-title {
            font-size: 15px;
            line-height: 2;
            margin: 0 25px;
        }

        .dlg-tt .dlg-title a {
            float: right;
            color: red;
        }

        .dlg-tt .dlg-buttons {
            position: fixed;
            bottom: 15px;
            right: 15px;
        }

        .button_a {
            padding: 3px;
            margin-left: 5px;
        }

        .button_a:hover {
            cursor: pointer;
        }

        .operate_btn {
            width: 80px;
            margin-left: 8px;
        }

        .operate_btn:first-child {
            margin-left: 0px;
        }
    </style>
</head>

<body>
<div id="tb" style="padding:5px">
    <div style="margin-bottom: 5px;">
        <input id="allInfo"/>
        <input id='身份证'></input>
        <input id='search'></input>
        <input id='试件形式'></input>
        <input id='合格位置'></input>
        <input id='焊接方法1'></input>
        <input id='焊接方法2'></input>
    </div>
    <div>
        <a href='#' class="easyui-linkbutton" onclick="btnLoad()">刷新</a>
        <a href='#' class="easyui-linkbutton" onclick="btnAdd()">添加</a>
        <!-- <a href='#' class="easyui-linkbutton operate_btn" style="width:150px" onclick="btnImport()">从考试结果导入</a> -->
        <a href='#' class="easyui-linkbutton" onclick="btnEditBat()">批量编辑</a>
        <a href='#' class="easyui-linkbutton" onclick="btnEditBat2()">设置焊工编号</a>
        <a href='#' class="easyui-linkbutton" onclick="uploadImg2()">上传照片</a>
        <a href='#' class="easyui-linkbutton" onclick="btnRemove()">删除选中行</a>
    </div>
</div>
<div style='overflow: auto'>
    <div id="dbGrid"></div>
</div>

<div id="dlg" class="easyui-dialog" title="新增对话框" style="width:430px;height:500px;padding:0px" data-options="
                     resizable:true,
                    modal:true,
                    closed:true,
                    buttons: '#dlg-buttons'">
    <form id="addNewForm">
    </form>
    <div id="dlg-buttons">
        <a href="javascript:void(0)" class="easyui-linkbutton" onclick="btnEditOk()">&nbsp;Save&nbsp;</a>
        <a href="javascript:void(0)" class="easyui-linkbutton" onclick="javascript:$('#dlg').dialog('close')">Close</a>
    </div>
</div>
<div id="dlg2" class="easyui-dialog" title="批量编辑对话框1" style="width:400px;height:450px;padding:0px" data-options="
                            resizable:true,
                        modal:true,
                        closed:true,
                        buttons: '#dlg-buttons21'">
    <form id="addUpdateForm">
        <div style="padding:5px 5px">
            <input name='起始行号' id='addUpdateFormstartNumber' classname='textbox'>
            <input name='结束行号' id='addUpdateFormendNumber' classname='textbox'>
        </div>
    </form>
    <div id="dlg-buttons21">
        <a href="javascript:void(0)" class="easyui-linkbutton" onclick="btnEditOk()">&nbsp;Save&nbsp;</a>
        <a href="javascript:void(0)" class="easyui-linkbutton" onclick="javascript:$('#dlg2').dialog('close')">Close</a>
    </div>
</div>

<div id="dlg21" class="easyui-dialog" title="批量设置焊工编号" style="width:410px;height:300px;padding:5px" data-options="
            resizable:true,
            modal:true,
            closed:true,
            buttons: '#dlg-buttons211'">
    <form id="addUpdateForm2">
        <div><input name='起始行号' id='1' classname='textbox'>
            <input name='结束行号' id='2' classname='textbox'></div>
        <div><input name='前缀' id='3' classname='textbox'></div>
        <div><input name='起始号' id='4' classname='textbox'></div>

        <div><label style='display: inline-block;width: 80'>焊工编号</label><input name='焊工编号' disabled='disabled'
                                                                               style="padding:3px;margin-left:5px;width:285px;">
        </div>
    </form>
    <div id="dlg-buttons211">
        <a href="javascript:void(0)" class="easyui-linkbutton" onclick="btnEditOk1()">&nbsp;Save&nbsp;</a>
        <a href="javascript:void(0)" class="easyui-linkbutton"
           onclick="javascript:$('#dlg21').dialog('close')">Close</a>
    </div>
</div>

<div id="dlg3" class="easyui-dialog" title="用户照片" style="width:400px;height:180px;padding:10px" data-options="iconCls:'icon-edit',
                     resizable:true,
                    modal:true,
                    closed:true,buttons: '#dlg-buttons31'">
    <form id="imgForm" method="post" enctype="multipart/form-data">
        <div style="text-align: center;font-size:16px;padding:5px;margin-bottom: 10px;">请上传以身份证命名的照片,支持同时批量上传</div>
        <input id="fileImg" name="file" style='width:365px;height:30px' placeholder="仅仅支持.bmp格式图片"
               class="easyui-filebox" multiple="multiple"
               data-options="buttonText:'选择照片',accept:'.bmp,.jpg,.jpeg,.png'"/>
    </form>
    <div id='dlg-buttons31'>
        <a href='#' class="easyui-linkbutton" style='width:60px' onclick="btnUpload2()">上传</a>
        <a href="javascript:void(0)" class="easyui-linkbutton" style='width:60px'
           onclick="javascript:$('#dlg3').dialog('close')">关闭</a>
    </div>
</div>

<div id="dlg31" class="easyui-dialog" title="照片" style="width:250px;height:250;padding:10px" data-options="iconCls:'icon-edit',
                     resizable:true,
                    modal:true,
                    closed:true">
    <img id='user_image' style="width:210px;height:210px;"/>
</div>
</body>
<script type="text/javascript">
    var model = {
        run: function (call, url, param, callback) {
            call(url, param, function (res) {
                !res.state && $.messager.info("error", res.data);
                res.state && callback && callback(res);
            })
        },
        get: function (param, callback) {
            model.run(AJAX.get, "/weldUserInfo/getCheckImage", param, callback);
        },
        getPic: function (param, callback) {
            model.run(AJAX.get, "/weldUserInfo/getPic", param, callback);
        },
        add: function (param, callback) {
            model.run(AJAX.post, "/weldUserInfo/insert", param, callback);
        },
        update: function (param, callback) {
            model.run(AJAX.post, "/weldUserInfo/update", param, callback);
        },
        updateBat: function (param, callback) {
            model.run(AJAX.post, "/weldUserInfo/updateBat", param, callback);
        },
        uploadFile: function (param, callback) {
            model.run(AJAX.postFile, "/weldUserInfo/uploadFile", param, callback);
        },
        importUser: function (param, callback) {
            model.run(AJAX.post, "/weldUserInfo/importUser", param, callback);
        },
        delete: function (param, callback) {
            model.run(AJAX.post, "/weldUserInfo/delete", param, callback);
        }
    }
</script>
<script type="text/javascript">
    var User = {}
    var flagBtn = 0 //按钮的标识
    var tianchong = {}; //填充金属类型
    var columns = [];
    var stateConst = {
        hasInputOk: "录入完整",
        notInputOk: "未录入完整",
        allInput: "所有",
    }
    var setTimeRun = function (call) {
        call && call()
    }
    //初始化
    $(function () {
        //检测用户
        config.userCheck(function (user) {
            User = user
        })

        var formItems = genBaseInput(_.cloneDeep(WeldIputForm));
        //对话框中的表单数据
        var genElement = [];
        var genElement2 = [];
        //初始化编辑表单
        setTimeout(function () {
            genElement = genEasyUi.getForm({
                id: "addNewForm",
            }, formItems);
            genFormItem(genElement).map(function (cell) {
                cell.width = 360;
                cell.labelWidth = 400 * 0.2;
                var call = genEasyUi.getElement(cell);
                call && call(cell);
            })

            var batUpate = ["合格位置","可焊位置","母材性质", "接头形式", "板厚", "管厚", "管径", "代用证日期", "代用证到期"];
            var element = formItems.map(function (cell) {
                return _.cloneDeep(cell);
            }).filter(function (cell) {
                //在批量编辑过程中所有内容项都不是必填项
                cell.required = false;
                return batUpate.indexOf(cell.name || cell.field) != -1;
            });
//            element = ([{viewName: "textbox", title: "起始行号", field: "startNumber"},
//                {viewName: "textbox", title: "结束行号", field: "endNumber"}]).concat(element);

            //批量编辑
            genElement2 = genEasyUi.getForm({
                id: "addUpdateForm",
            }, element);

            genFormItem(genElement2).map(function (cell) {
                cell.width = 360;
                cell.labelWidth = 400 * 0.2;
                var call = genEasyUi.getElement(cell);
                call && call(cell);
            })
            $("#addUpdateForm代用证日期").datebox({
                onChange: function (value1) {
                    var string = value1.split("-");
                    string[0] = parseInt(string[0]) + 3 + "";
                    $("#addUpdateForm代用证到期").datebox("setValue", string.join("-"));
                }
            });
            initConfigParams()
        }, 1);
        //获取时间  
        columns = [{
            field: 'ck',
            checkbox: true
        }, {
            field: '_id',
            title: '序号',
            width: 60,
            align: 'center',
            hidden: true
        }].concat(_.cloneDeep(formItems)).concat([{
            field: "操作",
            title: "操作",
            width: 150,
            formatter: function (val, row, index) {
                return ("<a class='button_a' onclick='editOne({0})'>编辑</a>" +
                "<a class='button_a' onclick='deleteOne({0})'>删除</a>").format(index);
            }
        }]);
        columns.forEach(function (cell) {
            if (cell.field == "照片") {
                cell.formatter = function (text, cell, index) {
                    var alinek = $("<a href='#' class='userinfo'></a>");
                    if (cell.是否上传照片 && cell.照片地址) {
                        alinek.attr("address", cell.照片地址);
                    }
                    alinek.text(cell.是否上传照片 && cell.照片地址 ? "Y" : "N");
                    var string = alinek.prop("outerHTML");
                    alinek.remove();
                    return string;
                }
            }
        })
        //表格参数设置
        $('#dbGrid').datagrid({
            width: 2000,
            height: document.documentElement.clientHeight - 35,
            method: 'GET',
            striped: true,
            fitColumns: true,
            singleSelect: false,
            rownumbers: true,
            pagination: false,
            nowrap: false,
            remoteSort: false,
            pageSize: 10,
            pageList: [10, 20, 50, 100, 150, 200],
            showFooter: true,
            toolbar: "#tb",
            columns: [columns],
            onClickRow: function (rowIndex, rowData) {
                $(this).datagrid('unselectAll');
                $(this).datagrid('selectRow', rowIndex);
            },
            rowStyler: function (index, row) {
                if (row["是否上传照片"] == false) {
                    return 'background-color:red;';
                }
            }
        })

        function getComboxField(fields) {
            return fields.filter(function (cell) {
                return cell.viewName === "combobox";
            });
        }

        //初始化配置
        function initConfigParams() {
            //加载配置
            function callF(cell) {
                return {
                    value: cell,
                    text: cell
                };
            }

            function getOptions(value, call) {
                if (!value) {
                    return [];
                }
                return value.map(call || callF);
            }

            function genRun(id, options) {
                return function () {
                    $("#" + id).combobox("loadData", options);
                }
            }

            var loadinit = function (data) {
                var chuanjishe = null;

                function addNewCombox(id, label, options, config) {
                    var _config = {
                        data: options,
                        textField: "text",
                        valueField: "value",
                        label: label,
                        labelWidth: 60,
                        width: 150,
                        onChange: btnLoad
                    };
                    _config = $.extend(_config, config, true);
                    $("#" + id).combobox(_config);
                }

                function initOneForm(elements) {
                    var fields = getComboxField(elements);
                    fields.forEach(function (cell) {
                        var options;
                        if (cell.field === "焊接方法1") {
                            options = getOptions(data.焊接方法, function (cell) {
                                return {
                                    value: cell[1],
                                    text: cell[1]
                                }
                            });
                        } else if (cell.field === "焊接方法2") {
                            options = getOptions(data.焊接方法, function (cell) {
                                return {
                                    value: cell[2],
                                    text: cell[2]
                                }
                            });
                        } else if (cell.field === "船级社") {
                            options = getOptions(data.船级社, function (cell) {
                                return {
                                    value: cell.name,
                                    text: cell.name,
                                    "考试位置": getOptions(cell.考试位置),
                                }
                            });
                            chuanjishe = options;
                        } else if (cell.field === "工区") {
                            options = getOptions(data.所属工区, function (cell) {
                                return {
                                    value: cell.name,
                                    text: cell.name,
                                    "施工队": getOptions(cell.施工队),
                                }
                            });
                        } else {
                            options = getOptions(data[cell.name || cell.field]);
                        }
                        if (_.isUndefined(options)) {
                            $.messager.info("error", "获取配置数据失败");
                        }

                        setTimeRun(genRun(cell.id, options));
                        if (cell.field === "船级社") {
                            addNewCombox("search", "船级社", options, {labelWidth: 50});
                        }

                        if (cell.field === "试件形式") {
                            addNewCombox("试件形式", "试件形式", options);
                        }
                        if (cell.field === "焊接方法1") {
                            addNewCombox("焊接方法1", "焊接方法1", options);
                        }
                        if (cell.field === "焊接方法2") {
                            addNewCombox("焊接方法2", "焊接方法2", options, {labelWidth: 65});
                        }

                    });
                }

                $("#" + "合格位置").textbox({
                    label: "合格位置",
                    labelWidth: 60,
                    width: 180,
                    onChange: btnLoad
                });
                $("#" + "可焊位置").textbox({
                    label: "可焊位置",
                    labelWidth: 60,
                    width: 180,
                    onChange: btnLoad
                });
                $("#身份证").textbox({
                    label: "身份证",
                    labelWidth: 45,
                    width: 180,
                    onChange: btnLoad
                });
                $("#allInfo").combobox({
                    data: [{"text": "未录入完整", value: stateConst.notInputOk}, {
                        text: "录入完整",
                        value: stateConst.hasInputOk
                    }, {text: "所有", value: stateConst.allInput}],
                    label: "数据完整性",
                    labelWidth: 65,
                    value: stateConst.notInputOk,
                    onChange: btnLoad,
                    width: 160,
                });
                data.填充金属.forEach(function (cell) {
                    tianchong[cell['2']] = cell['1'];
                });
                //新增编辑表单
                setTimeRun(function () {
                    initOneForm(genElement);
                })

                //批量编辑表单
                setTimeRun(function () {
                    initOneForm(genElement2);
                });
                //新增编辑中的级联选择
                setTimeRun(function () {
                    $("#addNewForm船级社").combobox({
                        "onSelect": function (record) {
                            $("#addNewForm考试位置").combobox("loadData", record.考试位置);
                        }
                    });
                })

                setTimeRun(function () {
                    $("#addNewForm工区").combobox({
                        "onSelect": function (record) {
                            $("#addNewForm施工队").combobox("loadData", record.施工队);
                        }
                    });
                })

                setTimeRun(function () {
                    $("#addNewForm焊接方法2").combobox({
                        "onChange": function (record) {
                            $("#addNewForm填充金属").textbox("setValue", tianchong[record] || "");
                        }
                    });
                    $("#addNewForm填充金属").textbox({
                        disabled: true,
                    });
                })
                var onChange1 = function () {
                    var values = getFormValue("#addUpdateForm2");
                    var value = "{0}-{1}".format(values
                            .前缀 || "",
                        values.起始号 || "");
                    $("#addUpdateForm2 input[name='焊工编号']").val(
                        value);
                }
                setTimeRun(function () {
                    $("#addUpdateForm2").data("getValues", function () {
                        var values = {};
                        $([1, 2, 3, 4]).each(function (index, cell) {
                            var name = $("#" + cell).attr("textboxname");
                            var value = $("#" + cell).textbox("getValue");
                            values[name] = value;
                        })
                        return values;
                    });

                    $("#addUpdateForm2").find("div").css({
                        width: "100%",
                        padding: "10px 0px"
                    }).find("#3,#4").each(function () {
                        var name = $(this).attr("name");
                        name != "焊工编号" && $(this).textbox({
                            label: name,
                            width: 380,
                            labelWidth: 60,
                            required: true,
                            onChange: onChange1
                        });
                    });
                    $("#addUpdateForm2").find("#1,#2").each(function () {
                        var name = $(this).attr("name");
                        $(this).textbox({
                            label: name,
                            width: 190,
                            labelWidth: 60,
                            onChange: onChange1
                        });
                    });
                })

                //对新增对话框中的代用证日期和到期日期进行特殊处理
                $("#addNewForm代用证日期").datebox({
                    onChange: function (value1) {
                        if (value1) {
                            var string = value1.split("-");
                            string[0] = parseInt(string[0]) + 3 + "";
                            var string2 = $("#addNewForm代用证到期").datebox("getValue");
                            !string2 && $("#addNewForm代用证到期").datebox("setValue", string.join("-"));
                        }
                    }
                });
                $("#addUpdateFormstartNumber").textbox({
                    label: "起始行号",
                    width: 180,
                    labelWidth: 80,
                });
                $("#addUpdateFormendNumber").textbox({
                    label: "结束行号",
                    width: 180,
                    labelWidth: 60,
                    marginLeft: 20,
                });

                //调整获取表单的数据的方法;
                var old = $("#addUpdateForm").data("getValues");
                $("#addUpdateForm").data("getValues", function () {
                    var values = old(true);
                    var start = $("#addUpdateFormstartNumber").textbox("getValue");
                    var end = $("#addUpdateFormendNumber").textbox("getValue");
                    values.startNumber = start;
                    values.endNumber = end;
                    return values;
                });
                //开始刷新页面
                setTimeRun(btnLoad);

            }
            config.loadConfigParam(loadinit);
        }

        // btnLoad();

        function initExampleInfo() {
            $("#examplePic").combobox({
                multiple: true,
                width: 250,
                formatter: function (row) {
                    //formatter方法就是实现了在每个下拉选项前面增加checkbox框的方法
                    var opts = $(this).combobox('options');
                    return '<input type="checkbox" class="combobox-checkbox">' + row[opts.textField]
                },
                onSelect: function (row) { //选中一个选项时调用
                    var opts = $(this).combobox('options');
                    //获取选中的值的values
                    //设置选中值所对应的复选框为选中状态
                    var el = opts.finder.getEl(this, row[opts.valueField]);
                    var element = el.find('input.combobox-checkbox')
                    element._propAttr('checked', true);
                },
                onUnselect: function (row) { //不选中一个选项时调用
                    var opts = $(this).combobox('options');
                    //获取选中的值的values
                    var el = opts.finder.getEl(this, row[opts.valueField]);
                    el.find('input.combobox-checkbox')._propAttr('checked', false);
                },
                data: [{
                    value: "1",
                    text: "2"
                }, {
                    value: "2",
                    text: "3"
                }]
            })
        }

        // setTimeRun(function() {
        //     initExampleInfo();
        // })
    })

    function showDialog(id, title) {
        $().dialog({
            title: title
        });
        $('#' + id).dialog('open');
    }

    function editOne(index) {
        var data = $("#dbGrid").datagrid("getData").rows[index];
        data.填充金属 = tianchong[data.焊接方法2];
        $("#addNewForm").data("setValues")(data);
        flagBtn = 2, showDialog("dlg", "编辑");
    }

    function deleteOne(index) {
        $.messager.confirm("确认", "删除选中的数据吗?", function (r) {
            if (!r) return;
            var row = $("#dbGrid").datagrid("getData").rows[index];
            model.delete(row, function (res) {
                $('#dbGrid').datagrid('deleteRow', index);
            });
        })
    }

    //刷新
    //页面未绑定任何，数据行与照片关联,照片是通过身份证号,进行关联的,因此存在,身份证
    //上传后,而未修正数据是录入完整的状态,所有单独传递一个参数,用于表示是从上传照片的接口的回调
    //并在回调中判定获取到的数据是是正确状态,当不是正确状态的时候,则调整其状态值。
    function btnLoad(isUpdaloadImg) {
        function getValue(id, viewName) {
            var obj = $("#" + id);
            if (obj && obj[viewName]) {
                return obj[viewName]("getValue");
            }
            return null;
        }

        function setQuery(container, id, key, viewName) {
            try {
                var value = getValue(id, viewName || "combobox");
                if (value) {
                    container[key] = value;
                }
            } catch (e) {
                console.log(e);
            }
        }

        var filter = {};
        setQuery(filter, "身份证", "身份证", "textbox");
        if (!filter.身份证) {
            setQuery(filter, "search", "船级社");
            setQuery(filter, "试件形式", "试件形式");
            setQuery(filter, "合格位置", "合格位置", "textbox");
            setQuery(filter, "焊接方法1", "焊接方法1");
            setQuery(filter, "焊接方法2", "焊接方法2");
            var inputOk = getValue("allInfo", "combobox");
            if (inputOk && inputOk !== stateConst.allInput) {
                if (inputOk === stateConst.hasInputOk) {
                    filter.未录入全 = inputOk;
                } else {
                    filter.$or = [{"未录入全": stateConst.notInputOk}, {"未录入全": {$exists: false}}]
                }
            }
        }

        model.get({filter: filter}, function (res) {
            $('#dbGrid').datagrid('loadData', res.data);
            setTimeRun(function () {
                $(".userinfo").hover(function () {
                    $(this).attr("address") && $(this).text("查看");
                }, function () {
                    var string = $(this).attr("address");
                    $(this).text(string ? "Y" : "N");
                }).click(function () {
                    if (!$(this).attr("address")) return;
                    var cell = $(this);
                    var imgs = cell.attr("address");
                    if (imgs) {
                        var imgs = imgs.replace("static", "");
                        console.log(imgs);
                        $("#user_image").attr("src", "/" + imgs || "");
                        $("#dlg31").dialog("open");
                    } else {
                        $.messager.info("未上传照片无法查看");
                    }
                })
            }, 2)
        });
    }

    function mustSelect() {
        if ($('#dbGrid').datagrid('getChecked').length <= 0) {
            return $.messager.info("warning", "请先选择数据行再点击按钮")
        }
        return true;
    }
    //批量编辑
    function btnEditBat() {
        (flagBtn = 3) && showDialog("dlg2", "批量编辑");
    }
    //批量编辑2
    function btnEditBat2() {
        (flagBtn = 3) && showDialog("dlg21", "批量编辑");
    }

    //单个上传照片,上传的照片的身份证号码和选择的第一个用户的身份证号吗应是一致的。
    function uploadImg2() {
        $('#dlg3').dialog('open');
    }

    function btnUpload2() {
        $("#imgForm").form('submit', {
            url: '/upload/n',
            data: $("#imgForm").serialize(),
            onSubmit: function (param) {
                param.type = 6;
                return true
            },
            success: function (datas) {
                var items = JSON.parse(datas);
                var data = $("#dbGrid").datagrid("getData");
                if (!items.state) {
                    $.messager.info("error", "上传照片失败");
                    return;
                }
                $.messager.info("success", "上传照片成功");
                var hasUploadCard = items.data.map(function (cell) {
                    return cell.id;
                });

                var shouldAdjustState = data.rows.filter(function (node) {
                    if (hasUploadCard.indexOf(node.身份证) === -1) {
                        return false;
                    }
                    checkInfoIsOk(node);
                    if (node.未录入全 === stateConst.hasInputOk) {
                        return true;
                    }
                    return false;
                });

                if (shouldAdjustState.length <= 0) {
                    return btnLoad(true);
                }

                //递归循环,所有数据都更新之后在刷新页面
                //存在性能优化,最优是在服务器统一处理数据
                var callBack = function () {
                    if (shouldAdjustState.length <= 0) {
                        return btnLoad(true);
                    } else {
                        model.update(shouldAdjustState.pop(), callBack);
                    }
                }

                callBack();
            }
        });
        $('#dlg3').dialog('close')
    }

    function checkInfoIsOk(newObj) {
        var keys = [];
        _.each(columns, function (cell) {
            if (["ck", "_id", "操作", "照片"].indexOf(cell.field) === -1) {
                keys.push(cell.field);
            }
        });

        var notHas = _.some(keys, function (key) {
            if (!_.has(newObj, key)) {
                return true;
            }
            if (newObj[key] == "") {
                return true;
            }
            return false;
        });

        //判断表单需要填写的数据是否都需要填写
        if (notHas) {
            newObj.未录入全 = "未录入完整";
            return;
        }

        //表单填写完整之后,看照片是已经上传
        if (newObj.是否上传照片 && newObj.照片地址) {
            newObj.未录入全 = "录入完整";
        } else {
            //未上传照片所有也是不完整数据
            newObj.未录入全 = "未录入完整";
        }

    }
    function updateOne(newObj, selidx, callback) {
        newObj["更新用户"] = User.英文名;
        checkInfoIsOk(newObj);
        model.update(newObj, function (res) {
            $("#dbGrid").datagrid("updateRow", {
                index: selidx, //行索引
                row: newObj
            });
            callback && callback();
        })
    }

    //添加新的行
    function btnEditOk() {
        if (!$(flagBtn == 3 ? "#addUpdateForm" : "#addNewForm").form('validate')) {
            return $.messager.info("error", "红色显示为必填项,存在必填项未填写,请核实");
        }

        function edit() {
            var newObj = $("#addNewForm").data("getValues")();
            var selRow = $('#dbGrid').datagrid('getSelected');
            var selidx = $('#dbGrid').datagrid('getRowIndex', selRow);
            newObj._id = selRow._id;
            newObj.是否上传照片 = selRow.是否上传照片;
            newObj.照片地址 = selRow.照片地址;
            if (newObj.身份证 != selRow.身份证) {
                newObj.是否上传照片 = false;
                newObj.照片地址 = "";
            }
            updateOne(newObj, selidx, btnLoad);
        }

        function add() {
            var newObj = $("#addNewForm").data("getValues")();
            newObj.登记人 = User.英文名;
            newObj.createState = "手动创建";
            newObj.status = 0;
            //newObj.焊接方法1 = newObj.焊接方法.split(",")[0];
            //newObj.焊接方法2 = newObj.焊接方法.split(",")[1];
            //delete newObj["焊接方法"];
            checkInfoIsOk(newObj);
            model.add(newObj, function (res) {
                $("#dbGrid").datagrid("appendRow", res.data);
            })
        }

        //通过制定行号编辑数据
        function getUpdateCell(values) {
            return DataGridExtend.getSelectionsByRowNumber("dbGrid", values.startNumber, values.endNumber);
        }

        function updateBat() {
            var values = $("#addUpdateForm").data("getValues")(true);
            var datas = getUpdateCell(values);
            _.each(datas, function (selRow, index) {
                var selIdx = $('#dbGrid').datagrid('getRowIndex', selRow);
                var infos = {};
                _.extend(infos, selRow, values);
                infos["填充金属"] = tianchong[infos.焊接方法2];
                updateOne(infos, selIdx, index == datas.length - 1 ? btnLoad : null);
            });
            $("#addUpdateForm").data("resetValues")();
        }

        if (flagBtn === 2) {
            edit(), $('#dlg').dialog('close')
        }

        if (flagBtn === 1) {
            add(), $('#dlg').dialog('close')
        }

        if (flagBtn === 3) {
            updateBat(), $('#dlg2').dialog('close')
        }

        //关闭对话框

    }

    function PrefixInteger(num, length) {
        return (Array(length).join('0') + num).slice(-length);
    }

    function getFormValue(formId) {
        return $(formId).data('getValues')();
    }
    //批量设置焊工编号f
    function btnEditOk1() {
        /**
         * 获取需要批量更新的焊工数据
         */
        function getBatUpdateWelders(values) {
            return DataGridExtend.getSelectionsByRowNumber("dbGrid", values.起始行号, values.结束行号);
        }

        var values = getFormValue("#addUpdateForm2");
        var length = values.起始号.length;
        var start = parseInt(values.起始号);
        if (isNaN(start)) {
            return $.messager.info("error", "开始序列号必须为数字");
        }

        _.each(getBatUpdateWelders(values), function (selRow) {
            var selIdx = $('#dbGrid').datagrid('getRowIndex', selRow);
            var infos = {};
            _.extend(infos, selRow, {
                "焊工编号": values.前缀 + "-" + PrefixInteger(start, length)
            });
            start++;
            updateOne(infos, selIdx);
        });
        $("#dlg21").dialog("close");
    }
    //添加
    function btnAdd() {
        //清空新增对话框
        flagBtn = 1, showDialog("dlg", "新增");
    }

    //批量删除
    function btnRemove() {
        function call() {
            var rows = $('#dbGrid').datagrid('getChecked')
            rows.forEach(function (selRow) {
                model.delete(selRow, function (res) {
                    var selIdx = $('#dbGrid').datagrid('getRowIndex', selRow);  
                    $('#dbGrid').datagrid('deleteRow', selIdx);
                })
            });
        }

        $.messager.confirm('提示框', '你确定要删除吗?', call);
    }
</script>
</script>