<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>舟山中远海运重工--焊工管理--焊工总清单</title>
    <link rel="stylesheet" type="text/css" href="js/easyui-1.5.3/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="js/easyui-1.5.3/themes/icon.css">
    <script type="text/javascript" src="js/easyui-1.5.3/jquery.min.js"></script>
    <script type="text/javascript" src="js/easyui-1.5.3/jquery.easyui.min.js"></script>
    <script type="text/javascript" src='/WeldStaffWeb/js/easyui-1.5.3/datagridfilter.js'></script>
    <script type="text/javascript" src='js/easyui-1.5.3/locale/easyui-lang-zh_CN.js'></script>

    <script type="text/javascript" src="/WeldStaffWeb/weldstaff/ajax.js"></script>
    <script type="text/javascript" src="/WeldStaffWeb/weldstaff/config.js"></script>
    <script type="text/javascript" src="/WeldStaffWeb/weldstaff/weldform/lodash.js"></script>
    <script type="text/javascript" src="/WeldStaffWeb/weldstaff/weldform/genEasyUI.js"></script>
    <script type="text/javascript" src="/WeldStaffWeb/weldstaff/input.js"></script>
    <script type="text/javascript" src="/WeldStaffWeb/weldstaff/messager.js"></script>
    <style type="text/css">
        * {
            padding: 0px;
            margin: 0px;
        }

        .dialog-row {
            padding: 5px;
            align-items: baseline;
            vertical-align: middle;
        }

        .dialog-mask {
            position: fixed;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            background: #000;
            filter: alpha(opacity=50);
            opacity: .5;
            display: block;
            overflow-x: hidden;
            overflow-y: auto;
        }

        .dlg-tt {
            width: 750px;
            height: 450px;
            border: 1px solid #ddd;
            box-shadow: 0 3px 9px rgba(0, 0, 0, 0.5);
            border-radius: 4px;
            background-color: #fff;
            z-index: 11;
            display: none;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }

        .dlg-tt .dlg-title {
            font-size: 15px;
            line-height: 2;
            margin: 0 25px;
        }

        .dlg-tt .dlg-title a {
            float: right;
            color: red;
        }

        .dlg-tt .dlg-buttons {
            position: fixed;
            bottom: 15px;
            right: 15px;
        }

        .button_a {
            padding: 1px 2px;
            margin-left: 5px;
        }

        .button_a:hover {
            cursor: pointer;
        }

        .operate_btn {
            width: 80px;
            margin-left: 4px;
        }

        .operate_btn:first-child {
            margin-left: 0px;
        }

        .datagrid-header-row .datagrid-cell span {
            white-space: normal !important;
            word-wrap: normal !important;
        }
    </style>
</head>

<body>
<div id="tb" style="padding:5px">
    <div>
        <input id='date_1' name='发证日期' class="easyui-datebox textbox-f"
               data-options="label:'发证日期',width:160,labelWidth:60"></input>
        <spam style="width:8px;display: inline-block">~</spam>
        <input id='date_2' name='发证日期' class="easyui-datebox textbox-f" data-options="width:100"></input>
        &nbsp;
        <input id='date_3' name='到期日期' class="easyui-datebox textbox-f"
               data-options="label:'到期日期',width:160,labelWidth:60"></input>
        <spam style="width:8px;display: inline-block">~</spam>
        <input id='date_4' name='到期日期' class="easyui-datebox textbox-f" data-options="width:100"></input>
        <a href='#' class="easyui-linkbutton search" onclick="btnLoad()">搜索</a>
        <a href='#' class="easyui-linkbutton" onclick="resetQuery()">重置</a>
    </div>
    <div style="margin-top:8px;">
        <a href='#' class="easyui-linkbutton" onclick="btnLoad()">刷新</a>
        <a href='#' class="easyui-linkbutton" onclick="btnEdit()">编辑</a>
        <a href='#' class="easyui-linkbutton" onclick="btnEditBat()">批量编辑</a>
        <a href='#' class="easyui-linkbutton" onclick="downLoadExcel3()">下载代用证</a>
        <a href='#' class="easyui-linkbutton" onclick="downLoadQR()">下载二维码</a>
        <a href='#' class="easyui-linkbutton" onclick="uploadFile()">上传PDF证书</a>
        <a href='#' class="easyui-linkbutton" onclick="uploadExcelFile()">导入EXCEl</a>
        <a href='#' class="easyui-linkbutton" onclick="btnRemove()">删除选中行</a>
    </div>
</div>
<div style='overflow: auto'>
    <div id="dbGrid"></div>
</div>

<div id="dlg" class="easyui-dialog" title="新增对话框" style="width:400px;height:300px;padding:0px" data-options="
                     resizable:true,
                    modal:true,
                    closed:true,
                    buttons: '#dlg-buttons'">
    <form id="addNewForm">
    </form>
    <div id="dlg-buttons">
        <a href="javascript:void(0)" class="easyui-linkbutton" onclick="btnEditOk()">&nbsp;Save&nbsp;</a>
        <a href="javascript:void(0)" class="easyui-linkbutton" onclick="javascript:$('#dlg').dialog('close')">Close</a>
    </div>
</div>
<div id="dlg2" class="easyui-dialog" title="批量编辑对话框" style="width:400px;height:280px;padding:0px" data-options="
                            resizable:true,
                        modal:true,
                        closed:true,
                        buttons: '#dlg-buttons2'">
    <form id="addUpdateForm">
        <div style="padding:5px 5px">
            <input name='起始行号' id='addUpdateFormstartNumber' classname='textbox'>
            <input name='结束行号' id='addUpdateFormendNumber' classname='textbox'>
        </div>
    </form>
    <div id="dlg-buttons2">
        <a href="javascript:void(0)" class="easyui-linkbutton" onclick="btnEditOk()">&nbsp;Save&nbsp;</a>
        <a href="javascript:void(0)" class="easyui-linkbutton" onclick="javascript:$('#dlg2').dialog('close')">Close</a>
    </div>
</div>

</body>
<script type="text/javascript">
    var model = {
        run: function (call, url, param, callback) {
            call(url, param, function (res) {
                !res.state && $.messager.info("error", res.data);
                res.state && callback && callback(res);
            })
        },
        get: function (param, callback) {
            model.run(AJAX.get, "/weldUserInfo/get", param, callback);
        },
        add: function (param, callback) {
            model.run(AJAX.post, "/weldUserInfo/insert", param, callback);
        },
        update: function (param, callback) {
            model.run(AJAX.post, "/weldUserInfo/update", param, callback);
        },
        updateBat: function (param, callback) {
            model.run(AJAX.post, "/weldUserInfo/updateBat", param, callback);
        },
        uploadFile: function (param, callback) {
            model.run(AJAX.postFile, "/weldUserInfo/uploadFile", param, callback);
        },
        uploadExcelFile: function (param, callback) {
            model.run(AJAX.postFile, "/weldUserInfo/uploadExcelFile", param, callback);
        },
        delete: function (param, callback) {
            model.run(AJAX.post, "/weldUserInfo/delete", param, callback);
        }
    }
</script>
<script type="text/javascript">
    var User = {};
    var flagBtn = 0; //按钮的标识
    var filterOk = false; //点击过滤是否已经获取到过滤数据;
    var editRow = -1; //记录编辑行
    //初始化
    $(function () {
        //检测用户
        config.userCheck(function (user) {
            User = user
        })
        var formItems = genBaseInput(_.cloneDeep(WeldTotalForm));
        //对话框中的表单数据
        var genElement = [];
        var genElement2 = [];
        //初始化编辑表单
        setTimeout(function () {
            var batUpate1 = ["船级社证书号", "发证日期", "到期日期", "在厂状态"];
            var element1 = formItems.map(function (cell) {
                return _.cloneDeep(cell);
            }).filter(function (cell) {
                //在批量编辑过程中所有内容项都不是必填项
                cell.required = false;
                return batUpate1.indexOf(cell.name || cell.field) != -1;
            });

            genElement = genEasyUi.getForm({
                id: "addNewForm",
            }, element1);

            genFormItem(genElement).map(function (cell) {
                cell.width = 360;
                cell.labelWidth = 400 * 0.2;
                var call = genEasyUi.getElement(cell);
                call && call(cell);
            })

            var batUpate = ["发证日期", "到期日期", "在厂状态"];
            var element = formItems.map(function (cell) {
                return _.cloneDeep(cell);
            }).filter(function (cell) {
                //在批量编辑过程中所有内容项都不是必填项
                cell.required = false;
                return batUpate.indexOf(cell.name || cell.field) != -1;
            });
            //批量编辑
            genElement2 = genEasyUi.getForm({
                id: "addUpdateForm",
            }, element);

            genFormItem(genElement2).map(function (cell) {
                cell.width = 370;
                cell.labelWidth = 80;
                var call = genEasyUi.getElement(cell);
                call && call(cell);
            })


            initConfigParams()
        }, 1);

        function dowloadPdf(obj) {
            var iid = $(obj).attr("item_id");
            DownLoadFile({
                url: '/download/n', //请求的url
                data: {
                    id: iid,
                    type: 12
                } //要发送的数据
            });
        }

        window.dowloadPdf = dowloadPdf;

        function initTable(config) {
            var columnsF = _.cloneDeep(formItems);
            config = config || {};
            var configFilter = [];
            columnsF.forEach(function (cell) {
                var _cell = {};
                _cell.field = cell.field;
                if (cell.viewName == "combobox") {
                    _cell.type = "combobox";
                    _cell.options = {
                        data: config[cell.field] || [],
                        onChange: function (value) {
                            if (value == '') {
                                $('#dbGrid').datagrid('removeFilterRule', 'status');
                            } else {
                                $('#dbGrid').datagrid('addFilterRule', {
                                    field: _cell.field,
                                    op: 'equal',
                                    value: value
                                });
                            }
                            $('#dbGrid').datagrid('doFilter');
                            var values = $("#dbGrid").datagrid("getFilterValues");
                            console.log(values);
                        }
                    };
                } else if (cell.viewName == "datebox") {
                    _cell.type = "datebox";
                    _cell.options = {
                        onChange: function (value) {
                            if (value == '') {
                                $('#dbGrid').datagrid('removeFilterRule', _cell.field);
                            } else {
                                $('#dbGrid').datagrid('addFilterRule', {
                                    field: _cell.field,
                                    op: 'equal',
                                    value: value
                                });
                            }
                            $('#dbGrid').datagrid('doFilter');
                        }
                    }
                } else {
                    _cell.type = "text";
                    _cell.value = "1";
                }
                configFilter.push(_cell);
            });
            columnsF.forEach(function (cell) {
                if (cell.field == "PDF") {
                    cell.formatter = function (value, row, index) {
                        if (!value) return "";
                        return "<a href='#' onclick='dowloadPdf(this)' item_id='" + row._id + "'>" + value + "</a>";
                    }
                }
            })
            //获取时间
            var columns = [{
                field: 'ck',
                checkbox: true
            }].concat(columnsF);
            columns.some(function (cell) {
                if (cell.field == "到期日期") {
                    cell.styler = function (index, row) {
                        var date = new Date().Format("yyyy-MM-dd");
                        if (row.到期日期 && row.到期日期 < date) {
                            return 'background-color:red;';
                        }
                    }
                    return true;
                }
            });
            //表格参数设置
            $('#dbGrid').datagrid({
                width: 2100,
                height: document.documentElement.clientHeight - 25,
                method: 'GET',
                striped: true,
                // fitColumns: true,
                singleSelect: false,
                rownumbers: true,
                pagination: false,
                nowrap: false,
                remoteSort: false,
                pageSize: 10,
                pageList: [10, 20, 50, 100, 150, 200],
                showFooter: false,
                toolbar: "#tb",
                columns: [columns],
                onClickRow: function (rowIndex, rowData) {
                    $(this).datagrid('unselectAll');
                    $(this).datagrid('selectRow', rowIndex);
                },
                onDblClickRow: function (rowIndex, rowData) {
                    //双击开启编辑行
                    if (editRow != -1 && editRow != rowIndex) {
                        $(this).datagrid("endEdit", editRow);
                    } else if (editRow != -1 && editRow == rowIndex) {
                        $(this).datagrid("endEdit", editRow);
                    } else {
                        $(this).datagrid("beginEdit", rowIndex);
                        editRow = rowIndex;
                    }
                },
                onAfterEdit: function (rowIndex, rowData, changes) {
                    var newObj = changes;
                    newObj._id = rowData._id;
                    model.update(newObj, function (res) {

                    });
                }
            })
            setTimeout(function () {
                $('#dbGrid').datagrid("enableFilter", configFilter);
            }, 1)
        }


        function getComboxField(fields) {
            return fields.filter(function (cell) {
                return cell.viewName === "combobox";
            });
        }

        //初始化配置
        function initConfigParams() {
            //加载配置
            function callF(cell) {
                return {
                    value: cell,
                    text: cell
                };
            }

            function getOptions(value, call) {
                if (!value) {
                    return [];
                }
                return value.map(call || callF);
            }

            var loadinit = function (data) {
                var initConfigOptions = {};

                function initOneForm(elements, isForm) {
                    var fields = getComboxField(elements);
                    isForm = isForm || false;
                    fields.forEach(function (cell) {
                        var options;
                        if (cell.field === "焊接方法") {
                            options = getOptions(data.焊接方法, function (cell) {
                                return {
                                    value: cell[1] + "," + cell[2],
                                    text: cell[1] + "," + cell[2]
                                }
                            });
                        } else if (cell.field === "船级社") {
                            options = getOptions(data.船级社, function (cell) {
                                return {
                                    value: cell.name,
                                    text: cell.name,
                                    "考试位置": getOptions(cell.考试位置),
                                }
                            });
                        } else if (cell.field === "所属工区") {
                            options = getOptions(data.所属工区, function (cell) {
                                return {
                                    value: cell.name,
                                    text: cell.name,
                                    "施工队": getOptions(cell.施工队),
                                }
                            });
                        } else {
                            options = getOptions(data[cell.name || cell.field]);
                        }
                        if (_.isUndefined(options)) {
                            $.messager.info("error", "获取配置数据失败");
                        }
                        options.forEach(function (cell) {
                            cell.key = cell.value;
                        });
                        if (isForm) {
                            $("#" + cell.id).combobox("loadData", options);
                        } else {
                            initConfigOptions[cell.field] = options;
                        }
                    })
                    ;
                }

                // //新增编辑表单
                initOneForm(genElement, true);
                //批量编辑表单
                initOneForm(genElement2, true);

                //新增编辑中的级联选择
                $("#addNewForm船级社").combobox({
                    "onSelect": function (record) {
                        $("#addNewForm考试位置").combobox("loadData", record.考试位置);
                    }
                });
                $("#addNewForm所属工区").combobox({
                    "onSelect": function (record) {
                        $("#addNewForm施工队").combobox("loadData", record.施工队);
                    }
                });
                //滤器的筛选初始化
                initOneForm(formItems, false);
                initTable(initConfigOptions);

                $("#addUpdateFormstartNumber").textbox({
                    label: "起始行号",
                    width: 185,
                    labelWidth: 80,
                });
                $("#addUpdateFormendNumber").textbox({
                    label: "结束行号",
                    width: 180,
                    labelWidth: 60,
                    marginLeft: 20,
                });

                //调整获取表单的数据的方法;
                var old = $("#addUpdateForm").data("getValues");
                $("#addUpdateForm").data("getValues", function () {
                    var values = old(true);
                    var start = $("#addUpdateFormstartNumber").textbox("getValue");
                    var end = $("#addUpdateFormendNumber").textbox("getValue");
                    values.startNumber = start;
                    values.endNumber = end;
                    return values;
                });

                btnLoad()
            }
            config.loadConfigParam(loadinit);
        }
    })

    function showDialog(id, title) {
        $().dialog({
            title: title
        });
        $('#' + id).dialog('open');
    }

    function editOne(index) {
        var data = $("#dbGrid").datagrid("getData").rows[index];
        $("#addNewForm").data("setValues")(data);
        flagBtn = 2, showDialog("dlg", "编辑");
    }

    function deleteOne(index) {
        $.messager.confirm("确认", "删除选中的数据吗?", function (r) {
            if (!r) return;
            var row = $("#dbGrid").datagrid("getData").rows[index];
            model.delete(row, function (res) {
                $('#dbGrid').datagrid('deleteRow', index);
            });
        })
    }
    var one = {};
    WeldTotalForm.forEach(function (cell) {
        one[cell.field] = "";
    });

    function getQuery() {
        var name1 = $("#date_1").datebox("getValue");
        var name2 = $("#date_2").datebox("getValue");
        var name3 = $("#date_3").datebox("getValue");
        var name4 = $("#date_4").datebox("getValue");
        var query = {};

        function getQuery(key, one, two) {
            if (one) {
                query[key] = {
                    "$gte": one,
                }
            }
            if (two) {
                var query1 = query[key] || {};
                query1["$lte"] = two;
                query[key] = query1;
            }
            return query;
        }

        getQuery("发证日期", name1, name2);
        getQuery("到期日期", name3, name4);
        return query;
    }

    //重置
    function resetQuery() {
        var keys = ["date_1", "date_2", "date_3", "date_4"];
        keys.forEach(function (key) {
            $("#" + key).datebox("setValue");
        });
        btnLoad();
    }
    //刷新
    function btnLoad(query) {
        var filter = {
            //"在厂状态": {"$neq":"离厂"},
        };
        _.extend(filter, query || {}, getQuery());
        model.get({
            filter: filter
        }, function (res) {
            var date = new Date().Format("yyyy-MM-dd");
            $('#dbGrid').datagrid('loadData', res.data.filter(function (cell) {
                return cell.在厂状态 != "离厂";//&& cell.到期日期>=date;
            }));
        });
    }

    function mustSelect() {
        if ($('#dbGrid').datagrid('getChecked').length <= 0) {
            return $.messager.info("warning", "请先选择数据行再点击按钮")
        }
        return true;
    }
    //批量编辑
    function btnEditBat() {
        (flagBtn = 3) && showDialog("dlg2", "批量编辑");
    }

    //文件上传对话框
    function uploadFile() {
        if (!mustSelect()) return;
        var selectFile;

        function isOk(file) {
            var last = file.name.split(".");
            if (["PDF", "pdf", 'png', "jpg"].indexOf(last[last.length - 1]) == -1) {
                return $.messager.info("error", "只支持pdf,jpg,png的格式", 4000);
            }
            return true;
        }

        $.Dialog("img_dialog_now",
            "<div style='text-align: center;padding:15px 15px'><div style='text-align:center;margin-top:-25px;margin-bottom:15px;font-size:14px;'>请选择需要上传的证书,支持pdf,jpg格式</div><input id='img_upload' style='width:100%' name='file'/>",
            function () {
                if (!isOk(selectFile)) return;
                $("#img_dialog_now").dialog("close");
                var selRow = $('#dbGrid').datagrid('getChecked')[0];
                var param = {
                    _id: selRow._id,
                    file: selectFile,
                    targetName: "PDF_file",
                    orgName: "PDF",
                };
                model.uploadFile(param, function (res) {
                    var selIdx = $('#dbGrid').datagrid('getRowIndex', selRow);
                    $("#dbGrid").datagrid("updateRow", {
                        index: selIdx, //行索引
                        row: res.data
                    })
                    $.messager.info("success", "上传PDF成功");
                });
            }, null, {
                width: 350,
                height: 150,
                onOpen: function () {
                    setTimeout(function () {
                        $("#img_upload").filebox({
                            buttonText: "浏览",
                            onChange: function () {
                                selectFile = $(this).context.ownerDocument.activeElement
                                    .files[0];
                            }
                        });
                    }, 1);
                }
            })
    }

    function uploadExcelFile() {
        var selectFile;

        function isOk(file) {
            var last = file.name.split(".");
            if (["xls", "xlsx"].indexOf(last[last.length - 1]) == -1) {
                return $.messager.info("error", "只支持xls,xlsx的格式", 4000);
            }
            return true;
        }

        $.Dialog("img_dialog_now",
            "<div style='text-align: left;padding:15px 15px'><div style='text-align:left;margin-top:-25px;font-size:14px;'>上传旧数据,xls格式的Excel文件</div><input id='img_upload' style='width:70%' name='file'/><a href='templates/hangongxinxihuizong.xls' style='float: right;'>下载上传模板</a>",
            function () {
                if (!isOk(selectFile)) return;
                $("#img_dialog_now").dialog("close");
                var param = {
                    file: selectFile,
                };
                //$.messager.info("warn", "上传接口已通,请提供旧数据模板");
                model.uploadExcelFile(param, function (res) {
                    $.messager.info("success", "上传Excel成功");
                    btnLoad();
                });
            }, null, {
                width: 350,
                height: 150,
                onOpen: function () {
                    setTimeout(function () {
                        $("#img_upload").filebox({
                            buttonText: "浏览",
                            onChange: function () {
                                selectFile = $(this).context.ownerDocument.activeElement
                                    .files[0];
                            }
                        });
                    }, 1);
                }
            })
    }


    //添加新的行
    function btnEditOk() {
        if (!$(flagBtn == 3 ? "#addUpdateForm" : "#addNewForm").form('validate')) {
            return $.messager.info("error", "红色显示为必填项,存在必填项未填写,请核实");
        }

        function updateOne(newObj, selidx) {
            newObj["更新用户"] = User.英文名;
            var call = (function (index, obj) {
                return function (res) {
                    if (obj.在厂状态 && obj.在厂状态 != "在厂") {
                        return $("#dbGrid").datagrid("deleteRow", selidx)
                    }
                    $("#dbGrid").datagrid("updateRow", {
                        index: index, //行索引
                        row: obj
                    })
                }
            })(selidx, newObj);

            model.update(newObj, call);
        }

        function edit() {
            var newObj = $("#addNewForm").data("getValues")();
            var selRow = $('#dbGrid').datagrid('getSelected');
            var selidx = $('#dbGrid').datagrid('getRowIndex', selRow);
            newObj._id = selRow._id;
            updateOne(newObj, selidx);
        }

        function add() {
            edit();
        }

        function updateBat() {
            var values = $("#addUpdateForm").data("getValues")(true);
            var datas = DataGridExtend.getSelectionsByRowNumber("dbGrid", values.startNumber, values.endNumber);
            _.each(datas, function (selRow) {
                var selIdx = $('#dbGrid').datagrid('getRowIndex', selRow);
                var infos = {};
                _.extend(infos, selRow, values);
                updateOne(infos, selIdx);
            });
            $("#addUpdateForm").data("resetValues")();

        }

        if (flagBtn === 2) {
            edit(), $('#dlg').dialog('close');
        }

        if (flagBtn === 1) {
            add(), $('#dlg').dialog('close')
        }

        if (flagBtn === 3) {
            updateBat(), $('#dlg2').dialog('close')
        }
        //关闭对话框

    }

    //单个编辑
    function btnEdit() {
        $("#addNewForm").data("resetValues")();
        if (!mustSelect()) {
            return;
        }
        var cell = $("#dbGrid").datagrid("getSelected");
        $("#addNewForm").data("setValues")(cell);
        (flagBtn = 1, showDialog("dlg", "单个编辑"));
    }


    //导出excel
    function downLoadExcel3() {
        if (!mustSelect()) {
            return
        }

        var rows = $('#dbGrid').datagrid('getChecked')
        var idStr = ""

        for (var i = 0, len = rows.length; i < len; i++) {
            if (i == 0) {
                idStr = rows[i]["_id"]

            } else {
                idStr = idStr + ',' + rows[i]["_id"]
            }
        }
        if (idStr != "") {
            DownLoadFile({
                url: '/download/n', //请求的url
                data: {
                    id: idStr,
                    type: 10
                } //要发送的数据
            });
        }
    }

    function downLoadQR() {
        if (!mustSelect()) return;
        var rows = $('#dbGrid').datagrid('getChecked')
        var idStr = ""

        for (var i = 0, len = rows.length; i < len; i++) {
            if (i == 0) {
                idStr = rows[i]["_id"]

            } else {
                idStr = idStr + ',' + rows[i]["_id"]
            }
        }
        if (idStr != "") {
            DownLoadFile({
                url: '/download/n', //请求的url
                data: {
                    id: idStr,
                    type: 11
                } //要发送的数据
            });
        }
    }

    //批量删除
    function btnRemove() {
        function call() {
            var rows = $('#dbGrid').datagrid('getChecked')
            rows.forEach(function (selRow) {
                model.delete(selRow, function (res) {
                    var selIdx = $('#dbGrid').datagrid('getRowIndex', selRow);  
                    $('#dbGrid').datagrid('deleteRow', selIdx);
                })
            });
        }

        $.messager.confirm('提示框', '你确定要删除吗?', call);
    }

    var DownLoadFile = function (options) {
        var dconfig = $.extend(true, {
            method: 'post'
        }, options);
        var $iframe = $('<iframe id="down-file-iframe" />');
        var $form = $('<form target="down-file-iframe" method="' + dconfig.method + '" />');
        $form.attr('action', dconfig.url);
        for (var key in dconfig.data) {
            $form.append('<input type="hidden" name="' + key + '" value="' + dconfig.data[key] + '" />');
        }
        $iframe.append($form);
        $(document.body).append($iframe);
        $form[0].submit();
        $iframe.remove();
    }
</script>