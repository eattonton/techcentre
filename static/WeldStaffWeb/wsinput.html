<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>舟山中远海运重工--焊工管理--考试申请</title>
    <link rel="stylesheet" type="text/css" href="js/easyui-1.5.3/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="js/easyui-1.5.3/themes/icon.css">
    <script type="text/javascript" src="js/easyui-1.5.3/jquery.min.js"></script>
    <script type="text/javascript" src="js/easyui-1.5.3/jquery.easyui.min.js"></script>

    <script type="text/javascript" src="/WeldStaffWeb/weldstaff/ajax.js"></script>
    <script type="text/javascript" src="/WeldStaffWeb/weldstaff/config.js"></script>
    <script type="text/javascript" src="/WeldStaffWeb/weldstaff/messager.js"></script>
    <script type="text/javascript" src="/WeldStaffWeb/weldstaff/initcombobox.js"></script>
    <style type="text/css">
        * {
            padding: 0px;
            margin: 0px;
        }
        
        .dialog-row {
            padding: 5px;
            align-items: baseline;
            vertical-align: middle;
        }
        
        .dialog-mask {
            position: fixed;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            background: #000;
            filter: alpha(opacity=50);
            opacity: .5;
            display: block;
            overflow-x: hidden;
            overflow-y: auto;
        }
        
        .dlg-tt {
            width: 750px;
            height: 450px;
            border: 1px solid #ddd;
            box-shadow: 0 3px 9px rgba(0, 0, 0, 0.5);
            border-radius: 4px;
            background-color: #fff;
            z-index: 11;
            display: none;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }
        
        .dlg-tt .dlg-title {
            font-size: 15px;
            line-height: 2;
            margin: 0 25px;
        }
        
        .dlg-tt .dlg-title a {
            float: right;
            color: red;
        }
        
        .dlg-tt .dlg-buttons {
            position: fixed;
            bottom: 15px;
            right: 15px;
        }
    </style>
</head>

<body>
    <div id="tb">
        <a href='#' class="easyui-linkbutton" onclick="btnLoad()">刷新</a>
        <a href='#' class="easyui-linkbutton" onclick="btnShowDlg2()">上传</a>
        <a href='#' class="easyui-linkbutton" onclick="btnAdd()">添加</a>
        <a href='#' class="easyui-linkbutton" onclick="btnRemove()">删除</a>
        <a href='#' class="easyui-linkbutton" onclick="btnEdit()">编辑</a>
        <a href='#' class="easyui-linkbutton" onclick="btnBatEdit()">批量编辑</a>
        所属工区:<div id="所属工区2" style="width:150px"></div>
        施工队:<div id="施工队2" style="width:150px"></div>
    </div>
    <div style="overflow: auto">
        <div id="dbGrid"></div>
    </div>

    <div id="dlg" class="easyui-dialog" title="编辑对话框" style="width:400px;height:500px;padding:0px" data-options="iconCls:'icon-edit',
                     resizable:true,
                    modal:true,
                    closed:true,
                    buttons: '#dlg-buttons'">
        <form id="addNewForm">
            <div id="行号0" class="dialog-row">
                <input class="easyui-textbox" id="行号1" style="width:45%" data-options="label:'行号'">
                    &nbsp;&nbsp;&nbsp;~&nbsp;&nbsp;&nbsp;
                <input class="easyui-textbox" id="行号2" style="width:25%" >
            </div>
            <div class="dialog-row">
                <input required="true" class="easyui-textbox" id="username" style="width:95%" data-options="label:'姓名:'">
            </div>
            <div class="dialog-row">
                <input required="true" class="easyui-textbox" id="userid" style="width:95%" data-options="label:'身份证:'">
            </div>
            <div class="dialog-row">
                <div id="性别" style="width:95%"></div>
            </div>
            <div class="dialog-row">
                <div id="船级社" style="width:95%"></div>
            </div>
            <div class="dialog-row">
                <div id="考试位置" style="width:95%"></div>
            </div>
            <div class="dialog-row">
                <div id="所属工区" style="width:95%"></div>
            </div>
            <div class="dialog-row">
                <div id="施工队" style="width:95%"></div>
            </div>
            <div class="dialog-row">
                <div id="焊接方法" style="width:95%"></div>
            </div>
    </div>
    <div id="dlg-buttons">
        <a href="javascript:void(0)" class="easyui-linkbutton" onclick="btnEditOk()">&nbsp;Save&nbsp;</a>
        <a href="javascript:void(0)" class="easyui-linkbutton" onclick="javascript:$('#dlg').dialog('close')">Close</a>
    </div>
    </form>
    <div id="dlg2" class="easyui-dialog" title="上传" style="width:400px;height:100px;padding:10px" data-options="iconCls:'icon-edit',
                     resizable:true,
                    modal:true,
                    closed:true">
        <form id="imgForm" method="post" enctype="multipart/form-data">
            <div>上传报验表</div>
            <input id="fileImg" name="file" class="easyui-filebox" data-options="buttonText:'选择表格',accept:'.xls'" />
            <a href='#' class="easyui-linkbutton" onclick="btnUpload()">上传</a>
            <a href="templates/kaosishenqing.xls" style="float: right;">下载上传模板</a>
        </form>
    </div>

</body>
<script type="text/javascript">
    var model = {
        run: function(call, url, param, callback) {
            call(url, param, function(res) {
                !res.state && $.messager.info("error", res.data);
                res.state && callback && callback(res);
            })
        },
        get: function(param, callback) {
            model.run(AJAX.get, "/weldstaff/get", param, callback);
        },
        update:function(param, callback){
            model.run(AJAX.post, "/weldstaff/update", param, callback);
        },
        insert:function(param, callback){
            model.run(AJAX.post, "/weldstaff/insert", param, callback);
        },
        remove:function(param, callback){
            model.run(AJAX.get, "/weldstaff/remove", param, callback);
        }
    }
</script>
<script type="text/javascript">
    var User = {}
    var flagBtn = 0 //按钮的标识
        //初始化
    $(function() {
        //检测用户
        config.userCheck(function(user) {
            User = user
        })

        initConfigParams()
    
        //表格参数设置
        $('#dbGrid').datagrid({
            width: 1400,
            height: document.documentElement.clientHeight,
            method: 'GET',
            striped: true,
            fitColumns: true,
            singleSelect: false,
            rownumbers: true,
            pagination: false,
            nowrap: false,
            remoteSort: false,
            pageSize: 10,
            pageList: [10, 20, 50, 100, 150, 200],
            showFooter: true,
            toolbar: "#tb",
            rowStyler: function(index, record) {
                var nhasV = function() {
                    for (var cell in arguments) {
                        if (!record[arguments[cell]]) {
                            return true;
                        }
                    }
                    return false;
                }
                if (nhasV("性别", "船级社", "考试位置", "焊接方法1", "焊接方法2", "工区", "施工队")) {
                    return 'background-color:pink;color:blue;font-weight:bold;';
                }
                return 'background-color:white;color:black;';
            },
            columns: [
                [{
                    field: 'ck',
                    checkbox: true
                }, {
                    field: '_id',
                    title: '序号',
                    width: 10,
                    align: 'center',
                    sortable: true,
                    hidden: true
                }, {
                    field: '姓名',
                    title: '姓名',
                    width: 10,
                    align: 'center',
                    sortable: true
                }, {
                    field: '身份证',
                    title: '身份证',
                    width: 30,
                    align: 'center',
                    sortable: true
                }, {
                    field: '性别',
                    title: '性别',
                    width: 10,
                    align: 'center'
                }, {
                    field: '船级社',
                    title: '船级社',
                    width: 10,
                    align: 'center'
                }, {
                    field: '考试位置',
                    title: '考试位置',
                    width: 20,
                    align: 'center'
                }, {
                    field: '工区',
                    title: '所属工区',
                    width: 20,
                    align: 'center'
                }, {
                    field: '施工队',
                    title: '施工队',
                    width: 20,
                    align: 'center',
                    sortable: true
                }, {
                    field: '焊接方法1',
                    title: '焊接方法1',
                    width: 20,
                    align: 'center',
                    sortable: true
                }, {
                    field: '焊接方法2',
                    title: '焊接方法2',
                    width: 20,
                    align: 'center',
                    sortable: true
                }]
            ],
            onClickRow: function(rowIndex, rowData) {
                $(this).datagrid('unselectAll');
                $(this).datagrid('selectRow', rowIndex);
            }
        })

        //初始化配置
        function initConfigParams() {
            
            var loadinit = function(data) {
                    loadComboboxFromArray('性别', data.性别);
                    loadComboboxFromArray('考试位置', data.考试位置);
                    loadCombobox1('所属工区', data.所属工区, workTeamFromArr);
                    loadCombobox1('所属工区2', data.所属工区, workTeamFromArr,"");
                    loadCombobox1('船级社', data.船级社, shipClassFromArr);
                    loadCombobox1('焊接方法', data.焊接方法, weldMethodFromArr);
                    loadComboboxFromArray('试件形式', data.试件形式);
                    loadComboboxFromArray('可焊板厚', data.可焊板厚);
                    loadComboboxFromArray('可焊管厚', data.可焊管厚);
                    loadComboboxFromArray('可焊管径', data.可焊管径);

                    $('#施工队').combobox({
                        textField: 'v',
                        valueField: 'v',
                        label: '施工队:'
                    });

                    $('#施工队2').combobox({
                        textField: 'v',
                        valueField: 'v',
                        label: '',
                        onChange:btnLoad
                    });

                    $("#所属工区").combobox({
                        onSelect: function(data) {
                            $("#施工队").combobox("setValue", "");
                            $("#施工队").combobox("loadData", getOptions(data.施工队, objFromArr));
                        }
                    });

                    $("#所属工区2").combobox({
                        onSelect: function(data) {
                            $("#施工队2").combobox("setValue", "");
                            $("#施工队2").combobox("loadData", getOptions(data.施工队, objFromArr));
                        },
                        onChange:btnLoad
                    });

                    $("#船级社").combobox({
                        onSelect: function(data) {
                            $("#考试位置").combobox("setValue", "");
                            $("#考试位置").combobox("loadData", getOptions(data.考试位置, objFromArr));
                        }
                    });

                    //刷新
                    btnLoad()
            }
                // console.log(window.parent.configParam);
                //window.parent.loadConfigParam(loadinit)
            config.loadConfigParam(loadinit);
        }
    })

    //刷新
    function btnLoad() {
        var filter = {};
        var val1 = $("#所属工区2").combobox("getValue");
        if(val1 == ""){
            filter["登记人"] = User["英文名"];
        }else{
            filter["工区"] = val1;
        }

        var val2 = $("#施工队2").combobox("getValue");
        if(val2 != ""){
            filter["施工队"] = val2;
        }
        
        //待审批的报验单
        filter["status"] = 0;
       
        model.get({filter: filter},function(res) {
            if (res.state) {
                $('#dbGrid').datagrid('loadData', res.data);
            }
        });
 
    }
 
    function btnShowDlg2() {
        $('#dlg2').dialog('open')
    }
    //上传考试名单
    function btnUpload() {
        $("#imgForm").form('submit', {
            url: '/upload/n',
            data: $("#imgForm").serialize(),
            onSubmit: function(param) {
                param.user = User.英文名
                param.type = 3
                return true
            },
            success: function(datas) {
                items = JSON.parse(datas)
                console.log(items)
                for (var i = 0, len1 = items.datas.length; i < len1; i++) {
                    $("#dbGrid").datagrid("appendRow", items.datas[i])
                }
                if (items.errors.length > 0) {
                    msg = items.errors.join('<br/>')
                    $.messager.alert('Warning', msg)
                }
            }
        });
        $('#dlg2').dialog('close')
    }

    function showDialog() {
        var cells = ["username", "userid", "可焊管径", "可焊管厚", "可焊板厚", "试件形式"];
        
        $("#dlg").find("[id]").each(function() {
            var id = $(this).attr("id");
            if (cells.indexOf(id) === -1) {
                return;
            }
            if (flagBtn === 3) {
                $(this).parent().css("display", "none");
            } else {
                $(this).parent().css("display", "block");
            }
        });
        $("#dlg").dialog("open");
    }

    function btnBatEdit() {
       // var rows = $('#dbGrid').datagrid('getChecked');
       // if (!rows || rows.length <= 0) {
       //     $.messager.info("error", "请先选择数据行再点击按钮");
       //     return false;
       // }
       $("#行号0").css("display", "block");
        //清空
        resetForm();
        (flagBtn = 3) && showDialog();
    }

    function getMustSelects() {
        var rows = $('#dbGrid').datagrid('getChecked');
        if (!rows || rows.length <= 0) {
            $.messager.info("error", "请先选择数据行再点击按钮");
            return false;
        }
        return rows;
    }
    //编辑现有的行
    function btnEdit() {
        var row = getMustSelects();
        if (!row) return;
        row = row[0];
        !row && $.messager.info("error", "请选数据行再点击按钮");
        $("#username").textbox("setValue", row.姓名);
        $("#userid").textbox("setValue", row.身份证);
        $('#userid').textbox('disable');
        $("#性别").combobox("setValue", row.性别);
        $("#船级社").combobox("setValue", row.船级社);
        $("#考试位置").combobox("setValue", row.考试位置);
        $("#所属工区").combobox("setValue", row.工区);
        $("#施工队").combobox("setValue", row.施工队);
        var weldstring = row.焊接方法1 && row.焊接方法2 ? row.焊接方法1 + "," + row.焊接方法2 : "";
        $("#焊接方法").combobox("setValue", weldstring)

        //
        flagBtn = 2;
        $('#dlg').dialog({
            title: "编辑"
        });
        $("#行号0").css("display", "none");
        showDialog();
    }
    //添加新的行
    function btnEditOk() {
        if (!$("#addNewForm").form('validate') && flagBtn !== 3) {
            return $.messager.alert("提示", "红色显示为必填项,存在必填项未填写,请核实");
        }
        var newObj = {}
        if(flagBtn == 3){
            //批量更新
            var val1 = $("#性别").combobox("getValue");
            if(val1 != "") newObj.性别 = val1;
            val1 = "";
            val1 = $("#船级社").combobox("getValue");
            if(val1 != "") newObj.船级社 = val1;
            val1 = "";
            val1 = $("#考试位置").combobox("getValue");
            if(val1 != "") newObj.考试位置 = val1;
            val1 = "";
            val1 = $("#所属工区").combobox("getValue");
            if(val1 != "") newObj.工区 = val1;
            val1 = "";
            val1 = $("#施工队").combobox("getValue");
            if(val1 != "") newObj.施工队 = val1;
            val1 = "";
            val1 = $("#焊接方法").combobox("getValue");
            if(val1 != ""){
                newObj.焊接方法 = val1;
                newObj.焊接方法1 = val1.split(",")[0];
                newObj.焊接方法2 = val1.split(",")[1];
            }
        }
        else{
            newObj.姓名 = $("#username").textbox("getValue");
            newObj.身份证 = $("#userid").textbox("getValue");
            newObj.性别 = $("#性别").combobox("getValue");
            newObj.船级社 = $("#船级社").combobox("getValue");
            newObj.考试位置 = $("#考试位置").combobox("getValue");
            newObj.工区 = $("#所属工区").combobox("getValue");
            newObj.施工队 = $("#施工队").combobox("getValue");
            var weldstring = $("#焊接方法").combobox("getValue");
            newObj.焊接方法 = weldstring;
            newObj.焊接方法1 = weldstring.split(",")[0];
            newObj.焊接方法2 = weldstring.split(",")[1];
            newObj.登记人 = User['英文名'];
        }
        //console.log(newObj);
        function updateOne(itemOne, sindex) {
            return function() {
                itemOne["更新用户"] = User.英文名
                //更新
                model.update(itemOne,function(res) {
                    if (res.state == false) {
                        return $.messager.info("error", "更新数据失败:{0}".format(itemOne["姓名"]));
                    }
                    $("#dbGrid").datagrid("updateRow", {
                        index: sindex, //行索引
                        row: {
                            data: itemOne
                        }
                    })
                });
                 
            }
        }

        if (flagBtn == 2) {
            //更新行
            var selRow = $('#dbGrid').datagrid('getSelected')
            var selidx = $('#dbGrid').datagrid('getRowIndex', selRow)
            $.extend(selRow, newObj);
            updateOne(selRow, selidx)();

            //关闭对话框
            $('#dlg').dialog('close')
        } else if (flagBtn == 1) {
            //添加
            model.insert(newObj,function(res) {
                if (res.state == false) {
                    alert("保存失败")
                } else {
                    //更新行
                    $("#dbGrid").datagrid("appendRow", res.data)
                }
            });
        } else if (flagBtn == 3) {
            var rows = []
            var rowIdx1 =parseInt($("#行号1").textbox("getValue"))
            var rowIdx2 =parseInt($("#行号2").textbox("getValue"))
            if(rowIdx1 >=1 && rowIdx2 >= rowIdx1){
                var rows2 = $('#dbGrid').datagrid('getRows')
                for(var j=rowIdx1;j<=rowIdx2;j++ ){
                    if((j-1) <rows2.length ){
                        rows.push(rows2[j-1])
                    }
                }
            }else{
                rows = $('#dbGrid').datagrid("getChecked")
            }
            //console.log(rows)
            rows.forEach(function(cell) {
                var selidx = $('#dbGrid').datagrid('getRowIndex', cell)
                $.extend(cell, newObj);
                updateOne(cell, selidx)();
            })
        }

        
    }

    //添加
    function btnAdd() {
        //打开对话框
        flagBtn = 1
        $('#dlg').dialog({
            title: "新加"
        });
        resetForm();
        showDialog();
    }

    function resetForm() {
        $("#行号1").textbox("setValue", "");
        $("#行号2").textbox("setValue", "");
        $("#username").textbox("setValue", "");
        $("#userid").textbox("setValue", "");
        $('#userid').textbox('enable');
        $("#性别").combobox("setValue", "");
        $("#船级社").combobox("setValue", "");
        $("#考试位置").combobox("setValue", "");
        $("#所属工区").combobox("setValue", "");
        $("#施工队").combobox("setValue", "");
        $("#焊接方法").combobox("setValue", "");
    }

    //删除
    function btnRemove() {
        $.messager.confirm('提示框', '你确定要删除吗?', function() {
            var rows = $('#dbGrid').datagrid('getChecked')
            rows.forEach(function(cell){
                var selIdx = $('#dbGrid').datagrid('getRowIndex', cell);
                var newObj = {}
                newObj._id = cell._id
                newObj.身份证 = cell.身份证
                model.remove(newObj,function(res) {
                    if (res.state) {
                        if (res.data["status"] == -1) {
                            $('#dbGrid').datagrid('deleteRow', selIdx);
                        }
                    }
                });
            });
             
        })
    }

    
</script>

</html>