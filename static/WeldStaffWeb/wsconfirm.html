<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>舟山中远海运重工--焊工管理--考试审核</title>
    <link rel="stylesheet" type="text/css" href="js/easyui-1.5.3/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="js/easyui-1.5.3/themes/icon.css">
    <script type="text/javascript" src="js/easyui-1.5.3/jquery.min.js"></script>
    <script type="text/javascript" src="js/easyui-1.5.3/jquery.easyui.min.js"></script>

    <script type="text/javascript" src="/WeldStaffWeb/weldstaff/ajax.js"></script>
    <script type="text/javascript" src="/WeldStaffWeb/weldstaff/config.js"></script>
    <script type="text/javascript" src="/WeldStaffWeb/weldstaff/messager.js"></script>
    <script type="text/javascript" src="/WeldStaffWeb/weldstaff/initcombobox.js"></script>
    <style type="text/css">
        * {
            padding: 0px;
            margin: 0px;
        }
        
        .dialog-row {
            padding: 5px;
            align-items: baseline;
            vertical-align: middle;
        }
        
        .dialog-mask {
            position: fixed;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            background: #000;
            filter: alpha(opacity=50);
            opacity: .5;
            display: block;
            overflow-x: hidden;
            overflow-y: auto;
        }
        
        .dlg-tt {
            width: 750px;
            height: 450px;
            border: 1px solid #ddd;
            box-shadow: 0 3px 9px rgba(0, 0, 0, 0.5);
            border-radius: 4px;
            background-color: #fff;
            z-index: 11;
            display: none;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }
        
        .dlg-tt .dlg-title {
            font-size: 15px;
            line-height: 2;
            margin: 0 25px;
        }
        
        .dlg-tt .dlg-title a {
            float: right;
            color: red;
        }
        
        .dlg-tt .dlg-buttons {
            position: fixed;
            bottom: 15px;
            right: 15px;
        }
    </style>
</head>

<body>
    <div id="tb">
        <a href='#' class="easyui-linkbutton" onclick="btnLoad()">刷新</a>
        <a href='#' class="easyui-linkbutton" onclick="btnBatEdit()">批量编辑</a>
        <a href='#' class="easyui-linkbutton" onclick="btnBatEdit2()">赋予试板编号</a>
        <a href='#' class="easyui-linkbutton" onclick="btnDate()">批量预约</a>
        <!-- <a href='#' class="easyui-linkbutton" onclick="btnEdit()">编辑</a> -->
        船级社:<div id="船级社" style="width:100px"></div>
        考试位置:<div id="考试位置" style="width:100px"></div>
        所属工区:<div id="所属工区" style="width:100px"></div>
        施工队:<div id="施工队" style="width:100px"></div>
        试件形式:<div id="试件形式2" style="width:100px"></div>
    </div>
    <div id="tb2">
        <a href='#' class="easyui-linkbutton" onclick="btnCheckCancel()">取消预约</a>
    </div>
    <div class="easyui-layout" data-options="fit:true">
        <div data-options="region:'north',split:true,border:false" style="height:360px">
            <div style="overflow: auto">
                <div id="dbGrid"></div>
            </div>
        </div>
        <div data-options="region:'center',border:false">
            <div style="overflow: auto">
                <div id="dbGrid2"></div>
            </div>
        </div>
    </div>
    </div>
    <div id="dlg2" class="easyui-dialog" title="预约登记" style="width:400px;height:400px;padding:0px" data-options="iconCls:'icon-edit',
                     resizable:true,
                    modal:true,
                    closed:true,
                    buttons: '#dlg-buttons2'">
        <form id="addNewForm">
            <div class="dialog-row">
                <div id="船级社2" style="width:95%" required="true" ></div>
            </div>
            <div class="dialog-row">
                <input class="easyui-datebox" id="booktime1" style="width:95%" required="true" data-options="formatter:config.myformatter,parser:config.myparser,label:'考试日期:'">
            </div>
            <div class="dialog-row">
                <input class="easyui-textbox" id="booktime2" style="width:95%" data-options="label:'考试时间:'">
            </div>
            <div class="dialog-row">
                <input required="true" class="easyui-textbox" id="考试批次" style="width:95%" data-options="label:'考试批次:'">
            </div>
        </form>
    </div>
    <div id="dlg-buttons2">
        <a href="javascript:void(0)" class="easyui-linkbutton" onclick="btnBookOk()">&nbsp;预约&nbsp;</a>
        <a href="javascript:void(0)" class="easyui-linkbutton" onclick="javascript:$('#dlg2').dialog('close')">关闭</a>
    </div>

    <div id="dlg3" class="easyui-dialog" title="批量编辑" style="width:400px;height:400px;padding:0px" data-options="iconCls:'icon-edit',
                     resizable:true,
                    modal:true,
                    closed:true,
                    buttons: '#dlg-buttons2'">
        <form id="addNewForm1">
            <div id="行号0" class="dialog-row">
                <input class="easyui-textbox" id="行号1" style="width:45%" data-options="label:'行号'">
                    &nbsp;&nbsp;&nbsp;~&nbsp;&nbsp;&nbsp;
                <input class="easyui-textbox" id="行号2" style="width:25%" >
            </div>
            <div class="dialog-row">
                <div id="试件形式" style="width:95%"></div>
            </div>
            <div class="dialog-row">
                <div id="板厚" style="width:95%"></div>
            </div>
            <div class="dialog-row">
                <div id="管厚" style="width:95%"></div>
            </div>
            <div class="dialog-row">
                <div id="管径" style="width:95%"></div>
            </div>
            <div class="dialog-row">
                <div id="管材" style="width:95%"></div>
            </div>
           
        </form>
    </div>

    <div id="dlg-buttons2">
        <a href="javascript:void(0)" class="easyui-linkbutton" onclick="btnBatEditOk()">&nbsp;确定&nbsp;</a>
        <a href="javascript:void(0)" class="easyui-linkbutton" onclick="javascript:$('#dlg3').dialog('close')">关闭</a>
    </div>

     <div id="dlg4" class="easyui-dialog" title="赋予试板编号" style="width:400px;height:160px;padding:0px" data-options="iconCls:'icon-edit',
                     resizable:true,
                    modal:true,
                    closed:true,
                    buttons: '#dlg-buttons4'">
        <form id="addNewForm4">
            <div class="dialog-row"></div>
            <div class="dialog-row"></div>
            <div class="dialog-row">
                <div id="试板编号" style="width:65%"></div>例:ZS190001,TW001
            </div>
        </form>
    </div>

    <div id="dlg-buttons4">
        <a href="javascript:void(0)" class="easyui-linkbutton" onclick="btnBatEditOk2()">&nbsp;确定&nbsp;</a>
        <a href="javascript:void(0)" class="easyui-linkbutton" onclick="javascript:$('#dlg4').dialog('close')">关闭</a>
    </div>
</body>
<script type="text/javascript">
    var model = {
        run: function(call, url, param, callback) {
            call(url, param, function(res) {
                !res.state && $.messager.info("error", res.data);
                res.state && callback && callback(res);
            })
        },
        get: function(param, callback) {
            model.run(AJAX.get, "/weldstaff/get", param, callback);
        },
        update:function(param, callback){
            model.run(AJAX.post, "/weldstaff/update", param, callback);
        },
        bookdate:function(param, callback){
            model.run(AJAX.get, "/weldstaff/bookdate", param, callback);
        },
        deldate:function(param, callback){
            model.run(AJAX.get, "/weldstaff/deldate", param, callback);
        }
    }
</script>
<script type="text/javascript">
    var User = {}
    $(function() {
        //检测用户
        config.userCheck(function(user) {
            User = user
        })

        initConfigParams()
        //表格参数设置
        $('#dbGrid').datagrid({
            height: 350,
            width: 1600,
            method: 'GET',
            striped: true,
            fitColumns: true,
            singleSelect: false,
            rownumbers: true,
            remoteSort: false,
            pagination: false,
            nowrap: false,
            pageSize: 10,
            pageList: [10, 20, 50, 100, 150, 200],
            showFooter: true,
            toolbar: "#tb",
            rowStyler: function(index, record) {
                var nhasV = function() {
                    if(!record["试件形式"] && !record["板厚"] && !record["试板编号"]){
                        return true;
                    }
                    if(!record["试件形式"] && !record["管厚"] && !record["管径"] && !record["管材"] && !record["试板编号"]){
                        return true;
                    }
                    return false;
                }
                if (nhasV()) {
                    return 'background-color:pink;color:blue;font-weight:bold;';
                }
                return 'background-color:white;color:black;';
            },
            columns: [
                [{
                    field: 'ck',
                    checkbox: true
                }, {
                    field: '_id',
                    title: '序号',
                    width: 10,
                    align: 'center',
                    sortable: true,
                    hidden:true
                }, {
                    field: '姓名',
                    title: '姓名',
                    width: 20,
                    align: 'center',
                    sortable: true
                }, {
                    field: '身份证',
                    title: '身份证',
                    width: 30,
                    align: 'center',
                    sortable: true
                }, {
                    field: '船级社',
                    title: '船级社',
                    width: 10,
                    align: 'center'
                },{
                    field: '考试位置',
                    title: '考试位置',
                    width: 15,
                    align: 'center'
                }, {
                    field: '工区',
                    title: '所属工区',
                    width: 20,
                    align: 'center'
                }, {
                    field: '施工队',
                    title: '施工队',
                    width: 20,
                    align: 'center',
                    sortable: true
                }, {
                    field: '焊接方法1',
                    title: '焊接方法1',
                    width: 20,
                    align: 'center',
                    sortable: true
                }, {
                    field: '焊接方法2',
                    title: '焊接方法2',
                    width: 20,
                    align: 'center',
                    sortable: true
                }, {
                    field: '试件形式',
                    title: '试件形式',
                    width: 20,
                    align: 'center',
                    sortable: true
                }, {
                    field: '板厚',
                    title: '板厚',
                    width: 20,
                    align: 'center',
                    sortable: true
                }, {
                    field: '管厚',
                    title: '管厚',
                    width: 20,
                    align: 'center'
                }, {
                    field: '管径',
                    title: '管径',
                    width: 20,
                    align: 'center'
                }, {
                    field: '管材',
                    title: '管材',
                    width: 20,
                    align: 'center'
                },  {
                    field: '试板编号',
                    title: '试板编号',
                    width: 20,
                    align: 'center'
                }]
            ],
            onClickRow: function(rowIndex, rowData) {
              //  $(this).datagrid('unselectAll');
               // $(this).datagrid('selectRow', rowIndex);
            }
        });

        $('#dbGrid2').datagrid({
            height: document.documentElement.clientHeight - 350,
            width: 1600,
            striped: true,
            fitColumns: true,
            singleSelect: false,
            rownumbers: true,
            remoteSort: false,
            pagination: false,
            nowrap: false,
            showFooter: false,
            toolbar: "#tb2",
            columns: [
                [{
                    field: 'ck',
                    checkbox: true
                }, {
                    field: '_id',
                    title: '序号',
                    width: 10,
                    align: 'center',
                    sortable: true,
                    hidden:true
                }, {
                    field: '姓名',
                    title: '姓名',
                    width: 20,
                    align: 'center',
                    sortable: true
                }, {
                    field: '身份证',
                    title: '身份证',
                    width: 30,
                    align: 'center',
                    sortable: true
                },{
                    field: '船级社',
                    title: '船级社',
                    width: 10,
                    align: 'center'
                },{
                    field: '考试位置',
                    title: '考试位置',
                    width: 15,
                    align: 'center'
                }, {
                    field: '工区',
                    title: '所属工区',
                    width: 20,
                    align: 'center'
                }, {
                    field: '施工队',
                    title: '施工队',
                    width: 20,
                    align: 'center',
                    sortable: true
                }, {
                    field: '焊接方法1',
                    title: '焊接方法1',
                    width: 20,
                    align: 'center',
                    sortable: true
                }, {
                    field: '焊接方法2',
                    title: '焊接方法2',
                    width: 20,
                    align: 'center',
                    sortable: true
                }, {
                    field: '试件形式',
                    title: '试件形式',
                    width: 20,
                    align: 'center',
                    sortable: true
                }, {
                    field: '板厚',
                    title: '板厚',
                    width: 20,
                    align: 'center',
                    sortable: true
                }, {
                    field: '管厚',
                    title: '管厚',
                    width: 20,
                    align: 'center'
                }, {
                    field: '管径',
                    title: '管径',
                    width: 20,
                    align: 'center'
                }, {
                    field: '管材',
                    title: '管材',
                    width: 20,
                    align: 'center'
                }, {
                    field: '试板编号',
                    title: '试板编号',
                    width: 20,
                    align: 'center'
                }, {
                    field: '考试日期',
                    title: '考试日期',
                    width: 20,
                    align: 'center'
                }, {
                    field: '考试时间',
                    title: '考试时间',
                    width: 20,
                    align: 'center'
                }, {
                    field: '考试批次2',
                    title: '考试批次',
                    width: 20,
                    align: 'center'
                }]
            ]
        });

        //初始化配置
        function initConfigParams() {
            //加载配置
            var loadinit = function(data) {
                loadComboboxFromArray('试件形式', data.试件形式);
                loadComboboxFromArray('试件形式2', data.试件形式,"");
                loadComboboxFromArray('考试位置', data.考试位置,"");

                $("#板厚").textbox({label: "板厚"});
                $("#管厚").textbox({label: "管厚"});
                $("#管径").textbox({label: "管径"});
                $("#管材").textbox({label: "管材"});

                loadCombobox1('船级社', data.船级社, shipClassFromArr,"");
                loadCombobox1('船级社2', data.船级社, shipClassFromArr,"船级社");
                loadCombobox1('所属工区', data.所属工区, workTeamFromArr,"");
                

                $('#施工队').combobox({
                    textField: 'v',
                    valueField: 'v'
                });

                $("#所属工区").combobox({
                    onSelect:function(data){
                        $('#施工队').combobox("setValue","");
                        $('#施工队').combobox("loadData", getOptions(data.施工队, objFromArr))
                    }
                })

                $("#船级社").combobox({
                    onSelect: function(data) {
                        $("#考试位置").combobox("setValue", "");
                        $("#考试位置").combobox("loadData", getOptions(data.考试位置, objFromArr));
                    }
                });
                $('#船级社').combobox({onChange:btnLoad})
                $('#考试位置').combobox({onChange:btnLoad})
                $('#施工队').combobox({onChange:btnLoad})
                $('#试件形式2').combobox({onChange:btnLoad})
                //只输入数字
                $("#考试批次").textbox('textbox').bind('keyup', function(e){
                    $("#考试批次").textbox('setValue', $(this).val().replace(/\D/g,''));
                });
                
                $("#试板编号").textbox({label: "试板编号"});

                
                //刷新
                btnLoad();

            }
            
            config.loadConfigParam(loadinit);
        };
 
       
    })
    var urlEncode = function(param, key, encode) {
        if (param == null) return '';
        var paramStr = '';
        var t = typeof(param);
        if (t == 'string' || t == 'number' || t == 'boolean') {
            paramStr += '&' + key + '=' + ((encode == null || encode) ? encodeURIComponent(param) : param);
        } else {
            for (var i in param) {
                var k = key == null ? i : key + (param instanceof Array ? '[' + i + ']' : '.' + i);
                paramStr += urlEncode(param[i], k, encode);
            }
        }
        return paramStr;
    };

    //刷新
    function btnLoad() {
        var filter1 = {};
        var filter2 = {};
        filter1["status"] = 0;
        filter2["status"] = 1;

        var shipClass = $('#船级社').combobox("getValue");
        if(shipClass != undefined && shipClass != ""){
            filter1["船级社"] = shipClass;
            filter2["船级社"] = shipClass;
        }

        var workShop = $('#所属工区').combobox("getValue");
        if(workShop != undefined && workShop != ""){
            filter1["工区"] = workShop;
            filter2["工区"] = workShop;
        }

        var workTeam = $('#施工队').combobox("getValue");
        if(workTeam != undefined && workTeam != ""){
            filter1["施工队"] = workTeam;
            filter2["施工队"] = workTeam;
        }

        var val4 = $('#考试位置').combobox("getValue");
        if(val4 != undefined && val4 != ""){
            filter1["考试位置"] = val4;
            filter2["考试位置"] = val4;
        }

        var val5 = $('#试件形式2').combobox("getValue");
        if(val5 != undefined && val5 != ""){
            filter1["试件形式"] = val5;
            filter2["试件形式"] = val5;
        }

        model.get({filter: filter1},function(res) {
            if (res.state) {
                $('#dbGrid').datagrid('loadData', res.data);
            }
        });
        
        model.get({filter: filter2},function(res) {
            if (res.state) {
                $('#dbGrid2').datagrid('loadData', res.data);
            }
        });
    }
 
    function btnDate() {
        $('#dlg2').dialog('open');
    }

    //批量编辑
    function btnBatEdit() {
        var rows = $('#dbGrid').datagrid('getChecked')
        if(rows.length > 0 ){
            $("#试件形式").combobox("setValue",rows[0]["试件形式"])
            $("#板厚").textbox("setValue",rows[0]["板厚"])
            $("#管厚").textbox("setValue",rows[0]["管厚"])
            $("#管径").textbox("setValue",rows[0]["管径"])
            $("#管材").textbox("setValue",rows[0]["管材"])
        }
        $("#行号1").textbox("setValue", "")
        $("#行号2").textbox("setValue", "")
        
       // $("#试板编号").textbox("setValue",rows[0]["试板编号"]);
        $('#dlg3').dialog('open')
    }

    function btnBatEdit2() {
        var rows = $('#dbGrid').datagrid('getChecked');
        if(rows.length == 0){
            return;
        }
        //$("#试板编号").textbox("setValue","");
        $('#dlg4').dialog('open');
    }

    //批量编辑确定
    function btnBatEditOk() {
        var rows = []
        var rowIdx1 =parseInt($("#行号1").textbox("getValue"))
        var rowIdx2 =parseInt($("#行号2").textbox("getValue"))
        if(rowIdx1 >=1 && rowIdx2 >= rowIdx1){
            var rows2 = $('#dbGrid').datagrid('getRows')
            for(var j=rowIdx1;j<=rowIdx2;j++ ){
                if((j-1) <rows2.length ){
                    rows.push(rows2[j-1])
                }
            }
        }else{
            rows = $('#dbGrid').datagrid("getChecked")
        }
        var values = {};
        var dataGrid = $("#dbGrid");
        //获取表单数据
        values["试件形式"] = $("#试件形式").combobox("getValue");
        values["板厚"] = $("#板厚").textbox("getValue");
        values["管厚"] = $("#管厚").textbox("getValue");
        values["管径"] = $("#管径").textbox("getValue");
        values["管材"] = $("#管材").textbox("getValue");
       //为每行设置数据
       rows.forEach(function(cell) {
            var selidx = $('#dbGrid').datagrid('getRowIndex', cell)
            $.extend(cell, values);
            updateOne(cell, selidx)();
        })
         
    }

    //批量填写试板编号
    function btnBatEditOk2() {
        var rows = $('#dbGrid').datagrid('getChecked');
        var values = {};
        var dataGrid = $("#dbGrid");
        //获取表单数据
        var sPrefix="";
        var iStartNo = 0;

        var value = $("#试板编号").textbox("getValue");
        values["试板编号"] = $.trim(value);

        var reg1 = /\d+/
        var reg2 = /\D+/
        iStartNo =parseInt(values["试板编号"].match(reg1)[0])
        sPrefix = values["试板编号"].match(reg2)[0]
       
       var i=0;
       rows.forEach(function(cell) {
            var selidx = $('#dbGrid').datagrid('getRowIndex', cell)
            iNo = iStartNo+i;
            values["试板编号"] = sPrefix + iNo;
            $.extend(cell, values);
            updateOne(cell, selidx)();
            i=i+1;
        })

        $('#dlg4').dialog('close');
 
    }

    function updateOne(itemOne, sindex) {
        return function() {
            itemOne["更新用户"] = User.英文名
            //更新
            model.update(itemOne,function(res) {
                if (res.state == false) {
                    return $.messager.info("error", "更新数据失败:{0}".format(itemOne["姓名"]));
                }
                $("#dbGrid").datagrid("updateRow", {
                    index: sindex, //行索引
                    row: {
                        data: itemOne
                    }
                })
            });
             
        }
    }

    //预约操作
    function btnBookOk() {
        if (!$("#addNewForm").form('validate')) {
            return $.messager.alert("提示", "红色显示为必填项,存在必填项未填写,请核实");
        }
        var sbooktime1 = $("#booktime1").datebox("getValue");
        var sbooktime2 = $("#booktime2").textbox("getValue");
        var sbookseq = $("#考试批次").textbox("getValue");
        var shipClass = $("#船级社2").textbox("getValue");
        var rows = $('#dbGrid').datagrid('getChecked');

        function checkDataIsOK(item) {
            if(!item["试件形式"] && !item["板厚"] && !item["试板编号"]){
                return false;
            }
            if(!item["试件形式"] && !item["管厚"] && !item["管径"] && !item["管材"] && !item["试板编号"]){
                return false;
            }

            return true;
        }

        rows.forEach(function(cell){
            if (!checkDataIsOK(cell)) {
                $.messager.info("error", "数据{0}的信息不完整,不允许预约考试".format(cell.姓名));
                 
            }
            var newObj = {};
            newObj._id = cell._id;
            newObj.考试日期 = sbooktime1;
            newObj.考试时间 = sbooktime2;
            newObj.考试批次 = sbookseq;
            newObj.考试批次2 = shipClass+"-"+sbookseq;
            newObj["status"] = 1;
            newObj.船级社 = shipClass;

            //上传服务器
            model.bookdate(newObj,function(res) {
                if (!res.state) {
                    return $.messager.info("error", "预约 {0} 的考试失败".format(cell["姓名"]));
                }
                $.extend(cell, newObj);
                $('#dbGrid2').datagrid('appendRow', cell);
                var rowIndex = $('#dbGrid').datagrid('getRowIndex', cell);
                $('#dbGrid').datagrid('deleteRow', rowIndex);
            });
        });
 
        $("#dlg2").dialog("close");
    }
    //取消预约
    function btnCheckCancel() {
        var rows = $('#dbGrid2').datagrid('getChecked');
        rows.forEach(function(cell){
            var newObj = {};
            newObj._id = cell._id;
            newObj["status"] = 0;
            //清空原始设置的值
            newObj.考试批次 = cell.考试批次;
            newObj.考试批次2 = cell.考试批次2;
            //上传服务器
            model.deldate(newObj,function(res) {
                if (res.state) {
                    $('#dbGrid').datagrid('appendRow', cell);
                    var rowIndex = $('#dbGrid2').datagrid('getRowIndex', cell);
                    $('#dbGrid2').datagrid('deleteRow', rowIndex);
                } else {
                    alert("取消失败")
                }
            });
        });
         
    }

</script>

</html>