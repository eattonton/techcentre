<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>舟山中远海运重工--焊工管理--CCS证书申请</title>
    <link rel="stylesheet" type="text/css" href="js/easyui-1.5.3/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="js/easyui-1.5.3/themes/icon.css">
    <script type="text/javascript" src="js/easyui-1.5.3/jquery.min.js"></script>
    <script type="text/javascript" src="js/easyui-1.5.3/jquery.easyui.min.js"></script>
    <script type="text/javascript" src='js/easyui-1.5.3/locale/easyui-lang-zh_CN.js'></script>

    <script type="text/javascript" src="/WeldStaffWeb/weldstaff/ajax.js"></script>
    <script type="text/javascript" src="/WeldStaffWeb/weldstaff/config.js"></script>
    <script type="text/javascript" src="/WeldStaffWeb/weldstaff/weldform/lodash.js"></script>
    <script type="text/javascript" src="/WeldStaffWeb/weldstaff/weldform/genEasyUI.js"></script>
    <script type="text/javascript" src="/WeldStaffWeb/weldstaff/input.js"></script>
    <script type="text/javascript" src="/WeldStaffWeb/weldstaff/messager.js"></script>
    <style type="text/css">
        * {
            padding: 0px;
            margin: 0px;
        }

        .dialog-row {
            padding: 5px;
            align-items: baseline;
            vertical-align: middle;
        }

        .dialog-mask {
            position: fixed;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            background: #000;
            filter: alpha(opacity=50);
            opacity: .5;
            display: block;
            overflow-x: hidden;
            overflow-y: auto;
        }

        .dlg-tt {
            width: 750px;
            height: 450px;
            border: 1px solid #ddd;
            box-shadow: 0 3px 9px rgba(0, 0, 0, 0.5);
            border-radius: 4px;
            background-color: #fff;
            z-index: 11;
            display: none;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }

        .dlg-tt .dlg-title {
            font-size: 15px;
            line-height: 2;
            margin: 0 25px;
        }

        .dlg-tt .dlg-title a {
            float: right;
            color: red;
        }

        .dlg-tt .dlg-buttons {
            position: fixed;
            bottom: 15px;
            right: 15px;
        }

        .button_a {
            padding: 3px;
            margin-left: 5px;
        }

        .button_a:hover {
            cursor: pointer;
        }

        .operate_btn {
            width: 80px;
            margin-left: 8px;
        }

        .operate_btn:first-child {
            margin-left: 0px;
        }

        .datagrid-header-row .datagrid-cell span {
            white-space: normal !important;
            word-wrap: normal !important;
        }

        .dlg31-form div {
            padding: 5px;
        }

        .dlg31-form label {
            width: 45px;
        }
    </style>
</head>

<body>
<div id="tb" style="padding:5px">
    <input id="search"/>
    <input id="exportstate"/>
    <input id="inputok"/>
    <a href='#' class="easyui-linkbutton" onclick="btnLoad()">刷新</a>
    <!-- <a href='#' class="easyui-linkbutton operate_btn" onclick="btnAdd()">添加</a> -->
    <a href='#' class="easyui-linkbutton" onclick="btnEditBat3()">批量编辑</a>
    <a href='#' class="easyui-linkbutton" style='width: 100px' onclick="btnEditBat31()">设置WPS编号</a>
    <a href='#' class="easyui-linkbutton" onclick="downLoadExcel2()">导出excel</a>
</div>
<div style='overflow: auto'>
    <div id="dbGrid"></div>
</div>

<div id="dlg" class="easyui-dialog" title="新增对话框" style="width:400px;height:500px;padding:0px" data-options="
                     resizable:true,
                    modal:true,
                    closed:true,
                    buttons: '#dlg-buttons'">
    <form id="addNewForm1">
    </form>
    <div id="dlg-buttons">
        <a href="javascript:void(0)" class="easyui-linkbutton" onclick="btnEditOk()">&nbsp;Save&nbsp;</a>
        <a href="javascript:void(0)" class="easyui-linkbutton" onclick="javascript:$('#dlg').dialog('close')">Close</a>
    </div>
</div>
<div id="dlg2" class="easyui-dialog" title="批量编辑对话框" style="width:400px;height:200px;padding:0px" data-options="
                            resizable:true,
                        modal:true,
                        closed:true,
                        buttons: '#dlg-buttons2'">
    <form id="addUpdateForm" style="padding-top:40px;padding-left:20px">
    </form>
    <div id="dlg-buttons2">
        <a href="javascript:void(0)" class="easyui-linkbutton" onclick="btnEditOk()">&nbsp;Save&nbsp;</a>
        <a href="javascript:void(0)" class="easyui-linkbutton" onclick="javascript:$('#dlg2').dialog('close')">Close</a>
    </div>
</div>

<div id="dlg3" class="easyui-dialog" title="编辑对话框" style="width:400px;height:500px;padding:0px" data-options="iconCls:'icon-edit',
                     resizable:true,
                    modal:true,
                    closed:true,
                    buttons: '#dlg-buttons3'">
    <form id="addNewForm">
        <div class="dialog-row">
            <input class="easyui-textbox" id="起始行号" style="width:47.5%" data-options="label:'起始行号:'">
            <input class="easyui-textbox" id="结束行号" style="width:47.5%" data-options="label:'结束行号:'">
        </div>
        <div class="dialog-row">
            <div id="证书类型" style="width:95%"></div>
        </div>
        <div class="dialog-row">
            <div id="工厂名称" style="width:95%"></div>
        </div>
        <div class="dialog-row">
            <div id="邮政编码" style="width:95%"></div>
        </div>
        <div class="dialog-row">
            <div id="联系地址" style="width:95%"></div>
        </div>
        <div class="dialog-row">
            <div id="新证" style="width:95%"></div>
        </div>
        <div class="dialog-row">
            <input class="easyui-textbox" id="原证书编号" style="width:95%" data-options="label:'原证书编号:'">
        </div>
        <div class="dialog-row">
            <div id="产品类型" style="width:95%"></div>
        </div>
        <div class="dialog-row">
            <input class="easyui-textbox" id="其他细节1" style="width:95%" data-options="label:'其他细节1:'">
        </div>
        <div class="dialog-row">
            <input class="easyui-textbox" id="其他细节2" style="width:95%" data-options="label:'其他细节2:'">
        </div>
    </form>
</div>
<div id="dlg-buttons3">
    <a href="javascript:void(0)" class="easyui-linkbutton" onclick="btnEditOk()">&nbsp;Save&nbsp;</a>
    <a href="javascript:void(0)" class="easyui-linkbutton" onclick="javascript:$('#dlg3').dialog('close')">Close</a>
</div>

<div id="dlg31" class="easyui-dialog" title="编辑对话框" style="width:400px;height:200px;padding:0px" data-options="iconCls:'icon-edit',
    resizable:true,
   modal:true,
   closed:true,
   buttons: '#dlg-buttons31'">
    <div class="dlg31-form">

        <div><input name='startNumber' id='startNumber' class='easyui-textbox' style='width:49%'
                    data-options="label:'起始行号',labelWidth:70"/>
            <input name='endNumber' id='endNumber' class='easyui-textbox' style='width:50%'
                   data-options="label:'结束行号',labelWidth:70"/></div>
        <div><input name='序号' id='p_number' class='easyui-textbox' style='width:100%'
                    data-options="label:'WPS编号',labelWidth:70"/></div>
    </div>

    <div id="dlg-buttons31">
        <a href="javascript:void(0)" class="easyui-linkbutton" onclick="btnEditOk1()">&nbsp;Save&nbsp;</a>
        <a href="javascript:void(0)" class="easyui-linkbutton"
           onclick="javascript:$('#dlg31').dialog('close')">Close</a>
    </div>
</div>
</body>
<script type="text/javascript">
    var model = {
        run: function (call, url, param, callback) {
            call(url, param, function (res) {
                !res.state && $.messager.info("error", res.data);
                res.state && callback && callback(res);
            })
        },
        get: function (param, callback) {
            model.run(AJAX.get, "/weldUserInfo/get", param, callback);
        },
        add: function (param, callback) {
            model.run(AJAX.post, "/weldUserInfo/insert", param, callback);
        },
        update: function (param, callback) {
            model.run(AJAX.post, "/weldUserInfo/update", param, callback);
        },
        updateBat: function (param, callback) {
            model.run(AJAX.post, "/weldUserInfo/updateBat", param, callback);
        },
        uploadFile: function (param, callback) {
            model.run(AJAX.postFile, "/weldUserInfo/uploadFile", param, callback);
        },
        delete: function (param, callback) {
            model.run(AJAX.post, "/weldUserInfo/delete", param, callback);
        }
    }
</script>
<script type="text/javascript">
    var User = {}
    var flagBtn = 0 //按钮的标识
    //初始化
    $(function () {
        //检测用户
        config.userCheck(function (user) {
            User = user
        })
        var formItems = genBaseInput(_.cloneDeep(WeldIputCCSForm));
        //对话框中的表单数据
        var genElement = [];
        var genElement2 = [];
        //初始化编辑表单
        setTimeout(function () {
            var element = formItems.filter(function (cell) {
                //在批量编辑过程中所有内容项都不是必填项
                cell.required = false;
                return true;
            });
            element = ([{viewName: "textbox", title: "起始行号", field: "startNumber"},
                {viewName: "textbox", title: "结束行号", field: "endNumber"}]).concat(element);

            //批量编辑
            genElement2 = genEasyUi.getForm({
                id: "addUpdateForm",
            }, element);

            genFormItem(genElement2).map(function (cell) {
                cell.width = 340;
                cell.labelWidth = 100;
                var call = genEasyUi.getElement(cell);
                call && call(cell);
            })

            initConfigParams()
        }, 1);
        //获取时间  
        var columns = [{
            field: 'ck',
            checkbox: true
        }, {
            field: '_id',
            title: '序号',
            width: 60,
            align: 'center',
            hidden: true
        }].concat(_.cloneDeep(formItems));

        //表格参数设置
        $('#dbGrid').datagrid({
            width: 2000,
            height: document.documentElement.clientHeight,
            method: 'GET',
            striped: true,
            // fitColumns: true,
            singleSelect: false,
            rownumbers: true,
            pagination: false,
            nowrap: false,
            remoteSort: false,
            pageSize: 10,
            pageList: [10, 20, 50, 100, 150, 200],
            showFooter: true,
            toolbar: "#tb",
            columns: [columns],
            // data: [{
            //     "姓名": "张三",
            //     "身份证": "1111",
            // }],
            onClickRow: function (rowIndex, rowData) {
                $(this).datagrid('unselectAll');
                $(this).datagrid('selectRow', rowIndex);
            }
        })

        function getComboxField(fields) {
            return fields.filter(function (cell) {
                return cell.viewName === "combobox";
            });
        }

        //初始化配置
        function initConfigParams() {
            //加载配置
            function getOptions(value, call) {
                return $(value).map(call).get();
            }

            function loadCombobox1(name, arr1, formatter) {
                $('#' + name).combobox({
                    data: getOptions(arr1, formatter),
                    textField: 't',
                    valueField: 'v',
                    label: name,
                    onLoadSuccess: function (data) {
                        if (data.length > 0) $(this).combobox('select', data[0].v);
                    }
                });
            }

            var loadinit = function (data) {
                loadCombobox1('证书类型', data.证书类型, function () {
                    return {
                        t: this,
                        v: this
                    }
                });
                loadCombobox1('工厂名称', data.工厂名称, function () {
                    return {
                        t: this,
                        v: this
                    }
                });
                // loadCombobox1('文化程度', data.文化程度, function() {
                //     return {
                //         t: this,
                //         v: this
                //     }
                // });
                loadCombobox1('邮政编码', data.邮政编码, function () {
                    return {
                        t: this,
                        v: this
                    }
                });
                loadCombobox1('联系地址', data.联系地址, function () {
                    return {
                        t: this,
                        v: this
                    }
                });
                loadCombobox1('产品类型', data.产品类型, function () {
                    return {
                        t: this,
                        v: this
                    }
                });
                loadCombobox1('新证', data.新证, function () {
                    return {
                        t: this,
                        v: this
                    }
                });
                $("#search").textbox({
                    width: 150,
                    label: "身份证",
                    labelWidth: 50,
                    onChange: btnLoad
                });
                $("#exportstate").combobox({
                    width: 200,
                    label: "导出状态",
                    labelWidth: 60,
                    textField: "text",
                    valueField: "value",
                    onChange: btnLoad,
                    value: "未导出",
                    data: [{text: "未导出", value: "未导出"}, {text: "已导出", value: "已导出"}, {text: "所有", value: "所有"}]
                });
                $("#inputok").combobox({
                    width: 200,
                    label: "数据完整性",
                    labelWidth: 70,
                    textField: "text",
                    valueField: "value",
                    onChange: btnLoad,
                    value: "未录入完整",
                    data: [{text: "未录入完整", value: "未录入完整"}, {text: "录入完整", value: "录入完整"}, {text: "所有", value: "所有"}]
                });

                btnLoad()
            }
            config.loadConfigParam(loadinit);
        }
    })

    function showDialog(id, title) {
        $().dialog({
            title: title
        });
        $('#' + id).dialog('open');
    }

    function editOne(index) {
        var data = $("#dbGrid").datagrid("getData").rows[index];
        $("#addNewForm").data("setValues")(data);
        flagBtn = 2, showDialog("dlg", "编辑");
    }

    function deleteOne(index) {
        $.messager.confirm("确认", "删除选中的数据吗?", function (r) {
            if (!r) return;
            var row = $("#dbGrid").datagrid("getData").rows[index];
            model.delete(row, function (res) {
                $('#dbGrid').datagrid('deleteRow', index);
            });
        })
    }

    //刷新
    function btnLoad() {
        var filter = {
            "船级社": "CCS",
        };
        var shen = $("#search").textbox("getValue");
        if (shen) {
            filter.身份证 = shen;
        }
        var exportState = $("#exportstate").combobox("getValue");
        if (exportState && exportState != "所有") {
            filter.导出状态 = exportState;
            if (exportState == "未导出") {
                filter.导出状态 = {$exists: false}
            }
        }
        var wanzheng = $("#inputok").combobox("getValue");
        if (wanzheng && wanzheng != "所有") {
            if (wanzheng == "录入完整") {
                filter.CSS录入完整 = wanzheng;
            } else {
                filter.$or = [{"CSS录入完整": {$exists: false}}, {"CSS录入完整": "未录入完整"}]
            }
        }
        model.get({
            filter: filter
        }, function (res) {
            $('#dbGrid').datagrid('loadData', res.data);
        });
    }

    function mustSelect() {
        return true;
        if ($('#dbGrid').datagrid('getChecked').length <= 0) {
            return $.messager.info("warning", "请先选择数据行再点击按钮")
        }
        return true;
    }
    //批量编辑
    function btnEditBat() {
        mustSelect() && (flagBtn = 3) && showDialog("dlg2", "批量编辑");
    }

    function btnEditBat3() {
        mustSelect() && (flagBtn = 3) && showDialog("dlg3", "批量编辑");
    }

    function btnEditBat31() {
        mustSelect() && showDialog("dlg31", "批量编辑");
    }

    //文件下载
    function downLoadExcel() {
        if (!mustSelect()) return $.messager.info("error", "请先选择数据");
        var selectFile;

        function isOk(file) {
            var last = file.name.split(".");
            if (["png", "jpeg"].indexOf(last[last.length - 1]) == -1) {
                return $.messager.info("error", "只支持jpeg,png的图片格式", 4000);
            }
            return true;
        }

        $.Dialog("img_dialog_now",
            "<div style='text-align: center'><img id='img_src' style='width:100%;height:165px'/></div><input id='img_upload' style='width:100%' name='file'/>",
            function () {
                if (!isOk(selectFile)) return;
                var selRow = $('#dbGrid').datagrid('getChecked')[0];
                var param = {
                    _id: selRow._id,
                    file: selectFile
                };
                model.uploadFile(param, function (res) {
                    var selIdx = $('#dbGrid').datagrid('getRowIndex', selRow);
                    $("#dbGrid").datagrid("updateRow", {
                        index: selIdx, //行索引
                        row: res.data
                    })
                    $("#img_dialog_now").dialog("close");
                    $.messager.info("success", "上传照片成功");
                });
            }, null, {
                width: 300,
                onOpen: function () {
                    setTimeout(function () {
                        $("#img_upload").filebox({
                            buttonText: "浏览",
                            onChange: function () {
                                selectFile = $(this).context.ownerDocument.activeElement
                                    .files[0];
                                var reader = new FileReader(); // 实例化一个FileReader对象，用于读取文件
                                var img = document.getElementById('img_src'); // 获取要显示图片的标签

                                //读取File对象的数据
                                reader.onload = function (evt) {
                                    img.src = evt.target.result;
                                }
                                reader.readAsDataURL(selectFile);
                                if (!isOk(selectFile)) {
                                    // $("#img_upload").filebox("setValue", "");
                                }
                                ;
                            }
                        });
                    }, 1);
                }
            })
    }

    //导出excel
    function downLoadExcel2() {
        var rows = $('#dbGrid').datagrid('getChecked');
        if (!rows || rows.length <= 0) {
            return $.messager.info("error", "请先选择需要导出的数据行数据");
        }
        var idStr = ""

        for (var i = 0, len = rows.length; i < len; i++) {
            if (i == 0) {
                idStr = rows[i]["_id"]

            } else {
                idStr = idStr + ',' + rows[i]["_id"]
            }
        }
        if (idStr != "") {
            DownLoadFile({
                url: '/download/n', //请求的url
                data: {
                    id: idStr,
                    type: 9
                } //要发送的数据
            });
        }
    }
    function checkInputIsOk(newObj) {
        if (newObj["证书类型"] && newObj["WPS编号"]) {
            newObj["CSS录入完整"] = "录入完整";
        } else {
            newObj["CSS录入完整"] = "未录入完整";
        }
    }
    //添加新的行
    function btnEditOk() {
        if (!$(flagBtn == 3 ? "#addUpdateForm" : "#addNewForm").form('validate')) {
            return $.messager.info("error", "红色显示为必填项,存在必填项未填写,请核实");
        }

        function updateOne(newObj, selidx) {
            newObj["更新用户"] = User.英文名;
            checkInputIsOk(newObj);
            model.update(newObj, function (res) {
                $("#dbGrid").datagrid("updateRow", {
                    index: selidx, //行索引
                    row: newObj
                })
            })
        }

        function edit() {
            var newObj = $("#addNewForm").data("getValues")();
            var selRow = $('#dbGrid').datagrid('getSelected');
            var selidx = $('#dbGrid').datagrid('getRowIndex', selRow);
            newObj._id = selRow._id;
            updateOne(newObj, selidx);
        }

        function add() {
            var newObj = $("#addNewForm").data("getValues")();
            newObj.创建者 = User.英文名;
            newObj.createState = "手动创建";
            model.add(newObj, function (res) {
                $("#dbGrid").datagrid("appendRow", res.data);
                // $.messager.info("success", "新增数据成功");
            })
        }

        function updateBat() {
            var values = $("#addUpdateForm").data("getValues")(true);
            _.each($('#dbGrid').datagrid('getSelections'), function (selRow) {
                var selIdx = $('#dbGrid').datagrid('getRowIndex', selRow);
                var selRow2 = $('#dbGrid').datagrid('getData').rows[selIdx];
                var infos = {};
                //_.extend(infos, selRow, values);
                console.log(selRow2)
                console.log(infos)
                console.log(selIdx)
                //updateOne(infos, selIdx);
            });
            $("#addUpdateForm").data("resetValues")();
        }

        function updateBat3() {
            //通过制定行号编辑数据
            function getUpdateCell(values) {
                return DataGridExtend.getSelectionsByRowNumber("dbGrid", values.startNumber, values.endNumber);
            }

            var values = getFormData1();
            values.startNumber = values.起始行号;
            values.endNumber = values.结束行号;

            _.each(getUpdateCell(values), function (selRow) {
                var selIdx = $('#dbGrid').datagrid('getRowIndex', selRow);
                values._id = selRow._id;
                updateOne(values, selIdx);
            });
            btnLoad();

        }

        if (flagBtn === 2) {
            edit(), $('#dlg').dialog('close')
        }

        if (flagBtn === 1) {
            add(), $('#dlg').dialog('close')
        }

        if (flagBtn === 3) {
            updateBat3(), $('#dlg3').dialog('close')
        }

        //关闭对话框

    }

    function PrefixInteger(num, length) {
        return (Array(length).join('0') + num).slice(-length);
    }

    function btnEditOk1() {
        if (!$(flagBtn == 3 ? "#addUpdateForm" : "#addNewForm").form('validate')) {
            return $.messager.info("error", "红色显示为必填项,存在必填项未填写,请核实");
        }

        function updateOne(newObj, selidx) {
            newObj["更新用户"] = User.英文名;
            checkInputIsOk(newObj);
            model.update(newObj, function (res) {
                $("#dbGrid").datagrid("updateRow", {
                    index: selidx, //行索引
                    row: newObj
                })
            })
        }

        function getUpdateCells(values) {
            return DataGridExtend.getSelectionsByRowNumber("dbGrid", values.startNumber, values.endNumber);
        }

        var val1 = $("#p_number").textbox("getValue");
        var startNumber = $("#startNumber").textbox("getValue");
        var endNumber = $("#endNumber").textbox("getValue");

        //连续生成WPS编号
        _.each(getUpdateCells({startNumber: startNumber, endNumber: endNumber}), function (selRow) {
            var selIdx = $('#dbGrid').datagrid('getRowIndex', selRow);
            var values = $.extend({}, selRow);
            values.WPS编号 = val1;
            values._id = selRow._id;
            updateOne(values, selIdx);
        });
        btnLoad();
        $("#dlg31").dialog("close");

    }

    function getFormData1() {
        var values = {};
        values.起始行号 = $("#起始行号").textbox("getValue")
        values.结束行号 = $("#结束行号").textbox("getValue")
        values.证书类型 = $("#证书类型").combobox("getValue")
        values.工厂名称 = $("#工厂名称").combobox("getValue")
        values.文化程度 = "/"; //$("#文化程度").combobox("getValue")
        values.焊接工作时间 = "/"; //$("#焊接工作时间").textbox("getValue")
        values.邮政编码 = $("#邮政编码").combobox("getValue")
        values.联系地址 = $("#联系地址").combobox("getValue")
        values.联系电话 = "/"; //$("#联系电话").textbox("getValue")
        values.焊接简历 = "/"; //$("#焊接简历").textbox("getValue")
        values.新证 = $("#新证").combobox("getValue")
        values.原证书编号 = $("#原证书编号").textbox("getValue")
        values.产品类型 = $("#产品类型").combobox("getValue")
        values.定位焊 = "/"; //$("#定位焊").textbox("getValue")
        values.其他细节1 = $("#其他细节1").textbox("getValue")
        values.其他细节2 = $("#其他细节2").textbox("getValue")

        return values;
    }

    //添加
    function btnAdd() {
        //清空新增对话框
        $("#addNewForm").data("resetValues")();
        flagBtn = 1, showDialog("dlg", "新增");
    }

    //批量删除
    function btnRemove() {
        function call(res) {
            res && _.each($('#dbGrid').datagrid('getChecked'), function (selRow) {
                var selIdx = $('#dbGrid').datagrid('getRowIndex', selRow);
                model.delete(selRow, function (res) {
                    $('#dbGrid').datagrid('deleteRow', selIdx);
                })
            });
        }

        $.messager.confirm('提示框', '你确定要删除吗?', call);
    }

    var DownLoadFile = function (options) {
        var dconfig = $.extend(true, {
            method: 'post'
        }, options);
        var $iframe = $('<iframe id="down-file-iframe" />');
        var $form = $('<form target="down-file-iframe" method="' + dconfig.method + '" />');
        $form.attr('action', dconfig.url);
        for (var key in dconfig.data) {
            $form.append('<input type="hidden" name="' + key + '" value="' + dconfig.data[key] + '" />');
        }
        $iframe.append($form);
        $(document.body).append($iframe);
        $form[0].submit();
        $iframe.remove();
    }
</script>