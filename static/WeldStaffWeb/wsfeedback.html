<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>舟山中远海运重工--焊工管理--结果评定</title>
    <link rel="stylesheet" type="text/css" href="js/easyui-1.5.3/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="js/easyui-1.5.3/themes/icon.css">
    <script type="text/javascript" src="js/easyui-1.5.3/jquery.min.js"></script>
    <script type="text/javascript" src="js/easyui-1.5.3/jquery.easyui.min.js"></script>

    <script type="text/javascript" src="/WeldStaffWeb/weldstaff/ajax.js"></script>
    <script type="text/javascript" src="/WeldStaffWeb/weldstaff/config.js"></script>
    <script type="text/javascript" src="/WeldStaffWeb/weldstaff/messager.js"></script>
    <script type="text/javascript" src="/WeldStaffWeb/weldstaff/initcombobox.js"></script>
    <style type="text/css">
        * {
            padding: 0px;
            margin: 0px;
        }
        
        .dialog-row {
            padding: 5px;
            align-items: baseline;
            vertical-align: middle;
        }
        
        .dialog-mask {
            position: fixed;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            background: #000;
            filter: alpha(opacity=50);
            opacity: .5;
            display: block;
            overflow-x: hidden;
            overflow-y: auto;
        }
        
        .dlg-tt {
            width: 750px;
            height: 450px;
            border: 1px solid #ddd;
            box-shadow: 0 3px 9px rgba(0, 0, 0, 0.5);
            border-radius: 4px;
            background-color: #fff;
            z-index: 11;
            display: none;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }
        
        .dlg-tt .dlg-title {
            font-size: 15px;
            line-height: 2;
            margin: 0 25px;
        }
        
        .dlg-tt .dlg-title a {
            float: right;
            color: red;
        }
        
        .dlg-tt .dlg-buttons {
            position: fixed;
            bottom: 15px;
            right: 15px;
        }
    </style>
</head>

<body>
    <div id="tb">
        <span>船级社:<div id="船级社" style="width:150px"></div></span>
        <span>考试批次:<div id="考试批次" style="width:150px"></div></span>
        <span>结果:<div id="结果2" style="width:150px"></div></span>
        <a href='#' class="easyui-linkbutton" onclick="btnBook()">批量登记结果</a>
    </div>
    <div style="overflow: auto">
        <div id="dbGrid"></div>
    </div>
  
    <div id="dlg3" class="easyui-dialog" title="结果登记" style="width:400px;height:300px;padding:0px" data-options="iconCls:'icon-edit',
                     resizable:true,
                    modal:true,
                    closed:true,
                    buttons: '#dlg-buttons3'">
        <div id="行号0" class="dialog-row">
            <input class="easyui-textbox" id="行号1" style="width:45%" data-options="label:'行号'">
                &nbsp;&nbsp;&nbsp;~&nbsp;&nbsp;&nbsp;
            <input class="easyui-textbox" id="行号2" style="width:25%" >
        </div>
        <div class="dialog-row">
            <div id="理论" style="width:95%"></div>
        </div>
        <div class="dialog-row">
            <div id="外观检查" style="width:95%"></div>
        </div>
        <div class="dialog-row">
            <div id="RT检查" style="width:95%"></div>
        </div>
        <div class="dialog-row">
            <div id="结果" style="width:95%"></div>
        </div>
      
    </div>
    <div id="dlg-buttons3">
        <a href="javascript:void(0)" class="easyui-linkbutton" onclick="btnBookOk()">&nbsp;登记&nbsp;</a>
        <a href="javascript:void(0)" class="easyui-linkbutton" onclick="javascript:$('#dlg3').dialog('close')">Close</a>
    </div>

</body>
<script type="text/javascript">
    var model = {
        run: function(call, url, param, callback) {
            call(url, param, function(res) {
                !res.state && $.messager.info("error", res.data);
                res.state && callback && callback(res);
            })
        },
        getBatch: function(param, callback) {
            model.run(AJAX.get, "/weldstaff/getrecord", param, callback);
        },
        get: function(param, callback) {
            model.run(AJAX.get, "/weldstaff/get", param, callback);
        },
        update:function(param, callback){
            model.run(AJAX.post,"/weldstaff/update",param, callback)
        }
    }
</script>
<script type="text/javascript">
    var User = {}
    var flagBtn = 0 //按钮的标识

    var resultData=[];
    var editRow = -1;
    var updateRows=[];
        //初始化
    $(function() {
        //检测用户
        config.userCheck(function(user) {
            User = user
        })

        initConfigParams()
            //设置今天
        var curr_time = new Date();
        var height = document.documentElement.clientHeight - 350;
        var columns = [{
            field: 'ck',
            checkbox: true
        }, {
            field: '_id',
            title: '序号',
            width: 10,
            align: 'center',
            hidden: true
        }, {
            field: '姓名',
            title: '姓名',
            width: 20,
            align: 'center',
            sortable: true
        }, {
            field: '身份证',
            title: '身份证',
            width: 30,
            align: 'center',
            sortable: true
        }, {
            field: '船级社',
            title: '船级社',
            width: 15,
            align: 'center'
        },{
            field: '工区',
            title: '所属工区',
            width: 20,
            align: 'center'
        }, {
            field: '施工队',
            title: '施工队',
            width: 20,
            align: 'center',
            sortable: true
        }, {
            field: '焊接方法1',
            title: '焊接方法1',
            width: 20,
            align: 'center',
            sortable: true
        }, {
            field: '焊接方法2',
            title: '焊接方法2',
            width: 20,
            align: 'center',
            sortable: true
        },{
            field: '考试位置',
            title: '考试位置',
            width: 15,
            align: 'center',
            sortable: true
        }, {
            field: '试件形式',
            title: '试件形式',
            width: 15,
            align: 'center',
            sortable: true
        }, {
            field: '考试日期',
            title: '考试日期',
            width: 20,
            align: 'center'
        }, {
            field: '考试批次2',
            title: '考试批次',
            width: 20,
            align: 'center'
        }, {
            field: '理论',
            title: '理论',
            width: 20,
            align: 'center',
            editor: { type: 'combobox', options: { data: resultData, valueField: "v", textField: "t"}}
        },{
            field: '外观检查',
            title: '外观检查',
            width: 20,
            align: 'center',
            editor: { type: 'combobox', options: { data: resultData, valueField: "v", textField: "t"}}
        }, {
            field: 'RT检查',
            title: 'RT检查',
            width: 20,
            align: 'center',
            editor: { type: 'combobox', options: { data: resultData, valueField: "v", textField: "t"}}
        }, {
            field: '结果',
            title: '结果',
            width: 20,
            align: 'center',
            editor: { type: 'combobox', options: { data: resultData, valueField: "v", textField: "t"}}
        }, {
            field: '合格位置',
            title: '合格位置',
            width: 20,
            align: 'center',
            formatter:function(value, rowData, rowIndex){
                if(value ==undefined || value == ""){
                    return rowData["考试位置"];
                }
                return value;
            },
            editor:{type:'textbox'}
        }];
        $('#dbGrid').datagrid({
            width: 1600,
            height: document.documentElement.clientHeight,
            method: 'GET',
            striped: true,
            fitColumns: true,
            singleSelect: false,
            rownumbers: true,
            pagination: false,
            nowrap: false,
            remoteSort: false,
            pageSize: 10,
            pageList: [10, 20, 50, 100, 150, 200],
            showFooter: true,
            toolbar: "#tb",
            columns: [columns],
            onClickRow: function(rowIndex, rowData) {
                $(this).datagrid('unselectAll');
                $(this).datagrid('selectRow', rowIndex);
            },
            rowStyler: function(index, row) {
                if (row["status"] == 1) {
                    return 'background-color:pink;color:blue;font-weight:bold;';
                }
            },
            onDblClickRow: function(rowIndex, rowData) {
                //双击开启编辑行
                if (editRow != -1 && editRow != rowIndex) {
                    $(this).datagrid("endEdit", editRow);
                    $(this).datagrid("beginEdit", rowIndex);
                    editRow = rowIndex;
                } else if (editRow != -1 && editRow == rowIndex) {
                    $(this).datagrid("endEdit", editRow);
                    editRow = -1;
                } else {
                    $(this).datagrid("beginEdit", rowIndex);
                    editRow = rowIndex;
                }

                if(editRow !=-1){
                    var editors = $('#dbGrid').datagrid('getEditors', rowIndex);//取当前的编辑器
                    $(editors[0].target).combobox({"data":resultData,"onChange":DataGridRowCBBChange});
                    $(editors[1].target).combobox({"data":resultData,"onChange":DataGridRowCBBChange});
                    $(editors[2].target).combobox({"data":resultData,"onChange":DataGridRowCBBChange});
                    $(editors[3].target).combobox({"data":resultData});

                    $(editors[0].target).combobox("setValue",rowData["理论"]);
                    $(editors[1].target).combobox("setValue",rowData["外观检查"]);
                    $(editors[2].target).combobox("setValue",rowData["RT检查"]);
                    $(editors[3].target).combobox("setValue",rowData["结果"]);
                    if(rowData["合格位置"] !=undefined && rowData["合格位置"] != ""){
                        $(editors[4].target).textbox("setValue",rowData["合格位置"]);
                    }else{
                        $(editors[4].target).textbox("setValue",rowData["考试位置"]);
                    }
                }
            },
            onAfterEdit:function(rowIndex,rowData,changes){
                var newObj = changes;
                newObj._id = rowData._id;
                if (newObj.结果 == "合格") {
                    newObj["status"] = 2;
                } else if (newObj.结果 == "不合格") {
                    newObj["status"] = 3;
                }
               // console.log(newObj);
                model.update(newObj,function(){
                    if (!res.state) {
                        return $.messager.info("error", "登记合格状态失败");
                    }
                    $("#dbGrid").datagrid("updateRow", {
                        index: rowIndex,
                        row: res.data
                    });
                });
            }
        })

        function DataGridRowCBBChange(n,v) {
            var editors = $('#dbGrid').datagrid('getEditors', editRow);//取当前的编辑器

            var res1 = $(editors[0].target).combobox("getValue");
            var res2 = $(editors[1].target).combobox("getValue");
            var res3 = $(editors[2].target).combobox("getValue");

            if(res1 !="" && res2 !="" && res3 != ""){
                if(res1 == "合格" && res2=="合格" && res3=="合格"){
                    $(editors[3].target).combobox("setValue","合格");
                }
                else
                {
                    $(editors[3].target).combobox("setValue","不合格");
                }
               
            }
        }

        function loadExamBatch(shipClass){
            var filter1 = {"船级社":shipClass};
            model.getBatch({filter:filter1}, function(res) {
                if (res.state) {
                    res.data.sort(function(two, one) {
                        return two["考试批次"] > one["考试批次"] ? -1 : 1;
                    })

                    $('#考试批次').combobox("loadData",res.data.splice(0, 12));
                        
                }
            });
        }

        function ResultFun1(){
            var val1 = $("#理论").combobox("getValue");
            var val2 = $("#外观检查").combobox("getValue");
            var val3 = $("#RT检查").combobox("getValue");

            if(val1 == "" || val2 == "" || val3 == ""){
                $("#结果").combobox("setValue","");
            }

            if(val1 == "不合格"){
                $("#外观检查").combobox("setValue","不合格");
                $("#RT检查").combobox("setValue","不合格");
                $("#结果").combobox("setValue","不合格");
            }

            if(val1 == "未考试"){
                $("#外观检查").combobox("setValue","未考试");
                $("#RT检查").combobox("setValue","未考试");
                $("#结果").combobox("setValue","未考试");
            }

            if(val1 == "合格" && val2 == "不合格"){
                $("#RT检查").combobox("setValue","不合格");
                $("#结果").combobox("setValue","不合格");
            }

            if(val1 == "合格" && val2 == "合格" && val3 == "合格"){
                $("#结果").combobox("setValue","合格");
            }

            if(val1 == "不合格" || val2 == "不合格" || val3 == "不合格"){
                $("#结果").combobox("setValue","不合格");
            }

            if(val1 == "未考试" || val2 == "未考试" || val3 == "未考试"){
                $("#结果").combobox("setValue","未考试");
            }
        }

        //初始化配置
        function initConfigParams() {
            //加载配置
            var loadinit = function(data) {
                resultData = getOptions(data.评定结果,objFromArr)

                loadCombobox1('船级社', data.船级社, shipClassFromArr,"");
                loadComboboxFromArray("理论",data.评定结果);
                loadComboboxFromArray("外观检查",data.评定结果);
                loadComboboxFromArray("RT检查",data.评定结果);
                loadComboboxFromArray("结果",data.评定结果);
                loadComboboxFromArray("结果2",data.评定结果,"");
                loadComboboxFromArray("外观检查",data.评定结果);
                loadComboboxFromArray("外观检查",data.评定结果);
                 
                $("#结果2").combobox({
                    onChange:btnLoad
                });

                $("#船级社").combobox({
                    onSelect:function(data){
                        loadExamBatch(data.v);
                    }
                });

                $('#考试批次').combobox({
                    textField: '考试批次2',
                    valueField: '考试批次2',
                    label: '',
                    onChange: btnLoad
                });

                $("#理论").combobox({
                    onChange:ResultFun1
                });

                $("#外观检查").combobox({
                    onChange:ResultFun1
                });

                $("#RT检查").combobox({
                    onChange:ResultFun1
                });
            }
            config.loadConfigParam(loadinit);
        }
 
    })
 
    //刷新
    function btnLoad() {
        var filter1 = {};
        var val1 = $('#考试批次').combobox("getValue");
        if(val1 != ""){
            filter1["考试批次2"] = val1;
        }

        var val2 = $('#船级社').combobox("getValue");
        if(val2 != ""){
            filter1["船级社"] = val2;
        }

     //   filter["$or"] = [{"结果": {'$exists': false}}, {"结果": ""}]
        var val3 = $('#结果2').combobox("getValue");
        if(val3 == ""){
            filter1["status"] = {"$in":[1,2,3,4]};
        }else if(val3 == "合格"){
            filter1["status"] = 2;
        }else if(val3 == "不合格"){
            filter1["status"] = 3;
        }else if(val3 == "未考试"){
            filter1["status"] = 4;
        }
 
        model.get({filter: filter1},function(res) {
            if (res.state) {
                $('#dbGrid').datagrid('loadData', res.data);
            }
        });
    }
 
    //登记
    function btnBook() {
        //var rows = $('#dbGrid').datagrid('getChecked');
        //if (rows.length <= 0) {
        //    return $.messager.info("error", "请选择数据行后,在点击登记按钮");
        //}
        $("#行号1").textbox("setValue", "")
        $("#行号2").textbox("setValue", "")
        $('#dlg3').dialog('open')
    }
  
    //批量登记结果
    function btnBookOk() {
        var newObj = {};

        newObj["理论"]= $("#理论").combobox("getValue");
        newObj["外观检查"]= $("#外观检查").combobox("getValue");
        newObj["RT检查"]= $("#RT检查").combobox("getValue");
        newObj["结果"]= $("#结果").combobox("getValue");
 
        var rows = []
        var rowIdx1 =parseInt($("#行号1").textbox("getValue"))
        var rowIdx2 =parseInt($("#行号2").textbox("getValue"))
        if(rowIdx1 >=1 && rowIdx2 >= rowIdx1){
            var rows2 = $('#dbGrid').datagrid('getRows')
            for(var j=rowIdx1;j<=rowIdx2;j++ ){
                if((j-1) <rows2.length ){
                    rows.push(rows2[j-1])
                }
            }
        }else{
            rows = $('#dbGrid').datagrid("getChecked")
        }

        rows.forEach(function(cell){
            newObj._id = cell._id;
            if(cell["合格位置"] != undefined && cell["合格位置"] != ""){
                newObj.合格位置 = cell["合格位置"];
            }else{
                newObj.合格位置 = cell["考试位置"];
            }
            
            if (newObj.结果 == "合格") {
                newObj["status"] = 2;
            }else if (newObj.结果 == "不合格") {
                newObj["status"] = 3;
            }else if (newObj.结果 == "未考试") {
                newObj["status"] = 4;
            }
            newObj["考核用户"] = User.英文名;
            //更新
            model.update(newObj,function(res) {
                if (!res.state) {
                    return $.messager.info("error", "登记合格状态失败");
                }
                var selidx = $('#dbGrid').datagrid('getRowIndex', cell);
                $("#dbGrid").datagrid("updateRow", {
                    index: selidx,
                    row: res.data
                });
            });
        });
        
        //关闭对话框
        $('#dlg3').dialog('close')
    }
</script>

</html>