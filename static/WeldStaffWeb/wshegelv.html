<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>舟山中远海运重工--焊工管理--合格率</title>
    <link rel="stylesheet" type="text/css" href="js/easyui-1.5.3/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="js/easyui-1.5.3/themes/icon.css">
    <script type="text/javascript" src="js/easyui-1.5.3/jquery.min.js"></script>
    <script type="text/javascript" src="js/easyui-1.5.3/jquery.easyui.min.js"></script>
    <script type="text/javascript" src='js/easyui-1.5.3/locale/easyui-lang-zh_CN.js'></script>

    <script type="text/javascript" src="/WeldStaffWeb/weldstaff/ajax.js"></script>
    <script type="text/javascript" src="/WeldStaffWeb/weldstaff/config.js"></script>
    <script type="text/javascript" src="/WeldStaffWeb/weldstaff/weldform/lodash.js"></script>
    <script type="text/javascript" src="/WeldStaffWeb/weldstaff/weldform/genEasyUI.js"></script>
    <script type="text/javascript" src="/WeldStaffWeb/weldstaff/input.js"></script>
    <script type="text/javascript" src="/WeldStaffWeb/weldstaff/messager.js"></script>
    <style type="text/css">
        * {
            padding: 0px;
            margin: 0px;
        }
        
        .dialog-row {
            padding: 5px;
            align-items: baseline;
            vertical-align: middle;
        }
        
        .dialog-mask {
            position: fixed;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            background: #000;
            filter: alpha(opacity=50);
            opacity: .5;
            display: block;
            overflow-x: hidden;
            overflow-y: auto;
        }
        
        .dlg-tt {
            width: 750px;
            height: 450px;
            border: 1px solid #ddd;
            box-shadow: 0 3px 9px rgba(0, 0, 0, 0.5);
            border-radius: 4px;
            background-color: #fff;
            z-index: 11;
            display: none;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }
        
        .dlg-tt .dlg-title {
            font-size: 15px;
            line-height: 2;
            margin: 0 25px;
        }
        
        .dlg-tt .dlg-title a {
            float: right;
            color: red;
        }
        
        .dlg-tt .dlg-buttons {
            position: fixed;
            bottom: 15px;
            right: 15px;
        }
        
        .button_a {
            padding: 3px;
            margin-left: 5px;
        }
        
        .button_a:hover {
            cursor: pointer;
        }
        
        .operate_btn {
            width: 80px;
            margin-left: 8px;
        }
        
        .operate_btn:first-child {
            margin-left: 0px;
        }
    </style>
</head>

<body>
    <div id="tb" style="padding:5px">
        <a href='#' class="easyui-linkbutton operate_btn" onclick="btnLoad()">刷新</a>
        <a href='#' class="easyui-linkbutton operate_btn" onclick="btnAdd()">添加</a>
        <a href='#' class="easyui-linkbutton operate_btn" style="width:150px" onclick="btnImport()">从考试结果导入</a>
        <a href='#' class="easyui-linkbutton operate_btn" onclick="btnEditBat()">批量编辑</a>
        <a href='#' class="easyui-linkbutton operate_btn" onclick="uploadImg2()">上传照片</a>
    </div>
    <div>
        <div id="dbGrid"></div>
    </div>

    <div id="dlg" class="easyui-dialog" title="新增对话框" style="width:430px;height:500px;padding:0px" data-options="
                     resizable:true,
                    modal:true,
                    closed:true,
                    buttons: '#dlg-buttons'">
        <form id="addNewForm">
        </form>
        <div id="dlg-buttons">
            <a href="javascript:void(0)" class="easyui-linkbutton" onclick="btnEditOk()">&nbsp;Save&nbsp;</a>
            <a href="javascript:void(0)" class="easyui-linkbutton" onclick="javascript:$('#dlg').dialog('close')">Close</a>
        </div>
    </div>
    <div id="dlg2" class="easyui-dialog" title="批量编辑对话框" style="width:400px;height:400px;padding:0px" data-options="
                            resizable:true,
                        modal:true,
                        closed:true,
                        buttons: '#dlg-buttons2'">
        <form id="addUpdateForm">
        </form>
        <div id="dlg-buttons2">
            <a href="javascript:void(0)" class="easyui-linkbutton" onclick="btnEditOk()">&nbsp;Save&nbsp;</a>
            <a href="javascript:void(0)" class="easyui-linkbutton" onclick="javascript:$('#dlg2').dialog('close')">Close</a>
        </div>
    </div>
    <div id="dlg3" class="easyui-dialog" title="上传" style="width:400px;height:100px;padding:10px" data-options="iconCls:'icon-edit',
                     resizable:true,
                    modal:true,
                    closed:true">
        <form id="imgForm" method="post" enctype="multipart/form-data">
            <div>上传以身份证命名的照片</div>
            <input id="fileImg" name="file" class="easyui-filebox" multiple="multiple" data-options="buttonText:'选择照片',accept:'.bmp'" />
            <a href='#' class="easyui-linkbutton" onclick="btnUpload2()">上传</a>

        </form>
    </div>
    <div id="dlg4" class="easyui-dialog" title="上传" style="width:400px;height:100px;padding:10px" data-options="iconCls:'icon-edit',
                     resizable:true,
                    modal:true,
                    closed:true">
        <form id="imgForm" method="post" enctype="multipart/form-data">
            <label>考试批次
            <input id="examplePic" name="examplePic" />
        </label>
            <a href='#' class="easyui-linkbutton" onclick="btnImportUser()">确定</a>
        </form>
    </div>
</body>
<script type="text/javascript">
    var model = {
        run: function(call, url, param, callback) {
            call(url, param, function(res) {
                !res.state && $.messager.info("error", res.data);
                res.state && callback && callback(res);
            })
        },
        get: function(param, callback) {
            model.run(AJAX.get, "/weldUserInfo/get", param, callback);
        },
        getPic: function(param, callback) {
            model.run(AJAX.get, "/weldUserInfo/getPic", param, callback);
        },
        add: function(param, callback) {
            model.run(AJAX.post, "/weldUserInfo/insert", param, callback);
        },
        update: function(param, callback) {
            model.run(AJAX.post, "/weldUserInfo/update", param, callback);
        },
        updateBat: function(param, callback) {
            model.run(AJAX.post, "/weldUserInfo/updateBat", param, callback);
        },
        uploadFile: function(param, callback) {
            model.run(AJAX.postFile, "/weldUserInfo/uploadFile", param, callback);
        },
        importUser: function(param, callback) {
            model.run(AJAX.post, "/weldUserInfo/importUser", param, callback);
        },
        delete: function(param, callback) {
            model.run(AJAX.post, "/weldUserInfo/delete", param, callback);
        }
    }
</script>
<script type="text/javascript">
    var User = {}
    var flagBtn = 0 //按钮的标识
    alert("开发中,请稍等.....")
        //初始化
    $(function() {
        //检测用户
        config.userCheck(function(user) {
            User = user
        })

        var formItems = genBaseInput(_.cloneDeep(WeldIputForm));
        //对话框中的表单数据
        var genElement = [];
        var genElement2 = [];
        //初始化编辑表单
        setTimeout(function() {
            genElement = genEasyUi.getForm({
                id: "addNewForm",
            }, formItems);
            genFormItem(genElement).map(cell => {
                cell.width = 360;
                cell.labelWidth = 400 * 0.2;
                var call = genEasyUi.getElement(cell);
                call && call(cell);
            })

            var batUpate = ["焊工编号", "母材性质", "填充金属", "接头形式", "代用证日期", "代用证到期"];
            var element = formItems.map(function(cell) {
                return _.cloneDeep(cell);
            }).filter(function(cell) {
                //在批量编辑过程中所有内容项都不是必填项
                cell.required = false;
                return batUpate.indexOf(cell.name || cell.field) != -1;
            });

            //批量编辑
            genElement2 = genEasyUi.getForm({
                id: "addUpdateForm",
            }, element);

            genFormItem(genElement2).map(cell => {
                cell.width = 360;
                cell.labelWidth = 400 * 0.2;
                var call = genEasyUi.getElement(cell);
                call && call(cell);
            })

            initConfigParams()
        }, 1);
        //获取时间  
        var columns = [{
            field: 'ck',
            checkbox: true
        }, {
            field: '_id',
            title: '序号',
            width: 60,
            align: 'center',
            sortable: true
        }].concat(_.cloneDeep(formItems)).concat([{
            field: "操作",
            title: "操作",
            width: 150,
            formatter: function(val, row, index) {
                return ("<a class='button_a' onclick='editOne({0})'>编辑</a>" +
                    "<a class='button_a' onclick='deleteOne({0})'>删除</a>").format(index);
            }
        }]);


        //表格参数设置
        $('#dbGrid').datagrid({
            width: 2000,
            height: document.documentElement.clientHeight,
            method: 'GET',
            striped: true,
            fitColumns: true,
            singleSelect: false,
            rownumbers: true,
            pagination: false,
            nowrap: false,
            remoteSort: false,
            pageSize: 10,
            pageList: [10, 20, 50, 100, 150, 200],
            showFooter: true,
            toolbar: "#tb",
            columns: [columns],
            // data: [{
            //     "姓名": "张三",
            //     "身份证": "1111",
            // }],
            onClickRow: function(rowIndex, rowData) {
                $(this).datagrid('unselectAll');
                $(this).datagrid('selectRow', rowIndex);
            }
        })

        function getComboxField(fields) {
            return fields.filter(function(cell) {
                return cell.viewName === "combobox";
            });
        }
        //初始化配置
        function initConfigParams() {
            //加载配置
            function callF(cell) {
                return {
                    value: cell,
                    text: cell
                };
            }

            function getOptions(value, call) {
                if (!value) {
                    return [];
                }
                return value.map(call || callF);
            }

            var loadinit = function(data) {
                function initOneForm(elements) {
                    var fields = getComboxField(elements);
                    fields.forEach(cell => {
                        var options;
                        if (cell.field === "焊接方法") {
                            options = getOptions(data.焊接方法, function(cell) {
                                return {
                                    value: cell[1] + "," + cell[2],
                                    text: cell[1] + "," + cell[2]
                                }
                            });
                        } else if (cell.field === "船级社") {
                            options = getOptions(data.船级社, function(cell) {
                                return {
                                    value: cell.name,
                                    text: cell.name,
                                    "考试位置": getOptions(cell.考试位置),
                                }
                            });
                        } else if (cell.field === "所属工区") {
                            options = getOptions(data.所属工区, function(cell) {
                                return {
                                    value: cell.name,
                                    text: cell.name,
                                    "施工队": getOptions(cell.施工队),
                                }
                            });
                        } else {
                            options = getOptions(data[cell.name || cell.field]);
                        }
                        if (_.isUndefined(options)) {
                            $.messager.info("error", "获取配置数据失败");
                        }
                        $("#" + cell.id).combobox("loadData", options);
                    });
                }
                //新增编辑表单
                initOneForm(genElement);

                //批量编辑表单
                initOneForm(genElement2);

                //新增编辑中的级联选择
                $("#addNewForm船级社").combobox({
                    "onSelect": function(record) {
                        $("#addNewForm考试位置").combobox("loadData", record.考试位置);
                    }
                });
                $("#addNewForm所属工区").combobox({
                    "onSelect": function(record) {
                        $("#addNewForm施工队").combobox("loadData", record.施工队);
                    }
                });
                $("#addNewForm焊接方法2").combobox({
                    "onChange": function(record) {
                        $("#addNewForm填充金属").combobox("setValue", record);
                    }
                });
            }
            config.loadConfigParam(loadinit);
        }
        btnLoad()

        function initExampleInfo() {
            $("#examplePic").combobox({
                multiple: true,
                width: 250,
                formatter: function(row) {
                    //formatter方法就是实现了在每个下拉选项前面增加checkbox框的方法
                    var opts = $(this).combobox('options');
                    return '<input type="checkbox" class="combobox-checkbox">' + row[opts.textField]
                },
                onSelect: function(row) { //选中一个选项时调用
                    var opts = $(this).combobox('options');
                    //获取选中的值的values
                    //设置选中值所对应的复选框为选中状态
                    var el = opts.finder.getEl(this, row[opts.valueField]);
                    var element = el.find('input.combobox-checkbox')
                    element._propAttr('checked', true);
                },
                onUnselect: function(row) { //不选中一个选项时调用
                    var opts = $(this).combobox('options');
                    //获取选中的值的values
                    var el = opts.finder.getEl(this, row[opts.valueField]);
                    el.find('input.combobox-checkbox')._propAttr('checked', false);
                },
                data: [{
                    value: "1",
                    text: "2"
                }, {
                    value: "2",
                    text: "3"
                }]
            })
        }
        setTimeout(function() {
            initExampleInfo();
            initExampleInfoInfo();
        }, 2);
    })

    function initExampleInfoInfo() {
        model.getPic({}, function(data) {
            if (!data.state) return;
            data.data.sort(function(two, one) {
                return two > one ? -1 : 1;
            });
            var options = data.data.map(function(cell) {
                return {
                    value: cell,
                    text: cell
                }
            });
            $("#examplePic").combobox("loadData", options)
        });
    }


    function showDialog(id, title) {
        $().dialog({
            title: title
        });
        $('#' + id).dialog('open');
    }

    function editOne(index) {
        var data = $("#dbGrid").datagrid("getData").rows[index];
        $("#addNewForm").data("setValues")(data);
        flagBtn = 2, showDialog("dlg", "编辑");
    }

    function deleteOne(index) {
        $.messager.confirm("确认", "删除选中的数据吗?", function(r) {
            if (!r) return;
            var row = $("#dbGrid").datagrid("getData").rows[index];
            model.delete(row, function(res) {
                $('#dbGrid').datagrid('deleteRow', index);
            });
        })
    }

    //刷新
    function btnLoad() {
        var filter = {};
        model.get({
            filter: filter
        }, function(res) {
            $('#dbGrid').datagrid('loadData', res.data);
        });
    }

    function mustSelect() {
        if ($('#dbGrid').datagrid('getChecked').length <= 0) {
            return $.messager.info("warning", "请先选择数据行再点击按钮")
        }
        return true;
    }
    //批量编辑
    function btnEditBat() {
        mustSelect() && (flagBtn = 3) && showDialog("dlg2", "批量编辑");
    }

    function uploadImg2() {
        $('#dlg3').dialog('open')
    }

    function btnUpload2() {
        $("#imgForm").form('submit', {
            url: '/upload/n',
            data: $("#imgForm").serialize(),
            onSubmit: function(param) {
                param.type = 6
                return true
            },
            success: function(datas) {
                items = JSON.parse(datas)
                console.log(items)
                $.messager.info("success", "上传照片成功");
            }
        });
        $('#dlg3').dialog('close')
    }

    //文件上传对话框
    function uploadImg() {
        if (!mustSelect()) return;
        var selectFile;

        function isOk(file) {
            var last = file.name.split(".");
            if (["png", "jpeg"].indexOf(last[last.length - 1]) == -1) {
                return $.messager.info("error", "只支持jpeg,png的图片格式", 4000);
            }
            return true;
        }
        $.Dialog("img_dialog_now",
            "<div style='text-align: center'><img id='img_src' style='width:100%;height:165px'/></div><input id='img_upload' style='width:100%' name='file'/>",
            function() {
                if (!isOk(selectFile)) return;
                var selRow = $('#dbGrid').datagrid('getChecked')[0];
                var param = {
                    _id: selRow._id,
                    file: selectFile,
                    targetName: "照片文件",
                    orgName: "照片",
                };
                model.uploadFile(param, function(res) {
                    var selIdx = $('#dbGrid').datagrid('getRowIndex', selRow);
                    $("#dbGrid").datagrid("updateRow", {
                        index: selIdx, //行索引
                        row: res.data
                    })
                    $("#img_dialog_now").dialog("close");
                    $.messager.info("success", "上传照片成功");
                });
            }, null, {
                width: 300,
                onOpen: function() {
                    setTimeout(function() {
                        $("#img_upload").filebox({
                            buttonText: "浏览",
                            onChange: function() {
                                selectFile = $(this).context.ownerDocument.activeElement
                                    .files[0];
                                var reader = new FileReader(); // 实例化一个FileReader对象，用于读取文件
                                var img = document.getElementById('img_src'); // 获取要显示图片的标签

                                //读取File对象的数据
                                reader.onload = function(evt) {
                                    img.src = evt.target.result;
                                }
                                reader.readAsDataURL(selectFile);
                                if (!isOk(selectFile)) {
                                    // $("#img_upload").filebox("setValue", "");
                                };
                            }
                        });
                    }, 1);
                }
            })
    }
    //添加新的行
    function btnEditOk() {
        if (!$(flagBtn == 3 ? "#addUpdateForm" : "#addNewForm").form('validate')) {
            return $.messager.info("error", "红色显示为必填项,存在必填项未填写,请核实");
        }

        function updateOne(newObj, selidx) {
            newObj["更新用户"] = User.英文名;
            model.update(newObj, function(res) {
                $("#dbGrid").datagrid("updateRow", {
                    index: selidx, //行索引
                    row: newObj
                })
            })
        }

        function edit() {
            var newObj = $("#addNewForm").data("getValues")();
            var selRow = $('#dbGrid').datagrid('getSelected');
            var selidx = $('#dbGrid').datagrid('getRowIndex', selRow);
            newObj._id = selRow._id;
            updateOne(newObj, selidx);
        }

        function add() {
            var newObj = $("#addNewForm").data("getValues")();
            newObj.登记人 = User.英文名;
            newObj.createState = "手动创建";
            newObj.status = 0;
            //newObj.焊接方法1 = newObj.焊接方法.split(",")[0];
            //newObj.焊接方法2 = newObj.焊接方法.split(",")[1];
            //delete newObj["焊接方法"];
            model.add(newObj, function(res) {
                $("#dbGrid").datagrid("appendRow", res.data);
                // $.messager.info("success", "新增数据成功");
            })
        }

        function updateBat() {
            var values = $("#addUpdateForm").data("getValues")(true);
            _.each($('#dbGrid').datagrid('getChecked'), function(selRow) {
                var selIdx = $('#dbGrid').datagrid('getRowIndex', selRow);
                var infos = {};
                _.extend(infos, selRow, values);
                updateOne(infos, selIdx);
            });
            $("#addUpdateForm").data("resetValues")();

        }
        if (flagBtn === 2) {
            edit(), $('#dlg').dialog('close')
        }

        if (flagBtn === 1) {
            add(), $('#dlg').dialog('close')
        }

        if (flagBtn === 3) {
            updateBat(), $('#dlg2').dialog('close')
        }

        //关闭对话框

    }

    //添加
    function btnAdd() {
        //清空新增对话框
        // $("#addNewForm").data("resetValues")();
        flagBtn = 1, showDialog("dlg", "新增");
    }

    //从考试合格的数据中导入用户信息
    function btnImport() {
        $("#dlg4").dialog("open");
    }

    function btnImportUser() {
        var values = $("#examplePic").combobox("getValues");
        var filter = {
            "考试批次": {
                "$in": values
            },
        }
        model.importUser(filter, function(data) {
            if (!data.state) return;
            $("#dlg4").dialog("close");
            btnLoad();
            //更新数据
            initExampleInfoInfo();
        });
    }
    //批量删除
    function btnRemove() {
        function call(res) {
            res && _.each($('#dbGrid').datagrid('getChecked'), function(selRow) {
                var selIdx = $('#dbGrid').datagrid('getRowIndex', selRow);
                model.delete(selRow, function(res) {
                    $('#dbGrid').datagrid('deleteRow', selIdx);
                })
            });
        }
        $.messager.confirm('提示框', '你确定要删除吗?', call);
    }
</script>