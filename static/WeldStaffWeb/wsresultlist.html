<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>舟山中远海运重工--焊工管理--考试结果清单</title>
    <link rel="stylesheet" type="text/css" href="js/easyui-1.5.3/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="js/easyui-1.5.3/themes/icon.css">
    <script type="text/javascript" src="js/easyui-1.5.3/jquery.min.js"></script>
    <script type="text/javascript" src="js/easyui-1.5.3/jquery.easyui.min.js"></script>

    <script type="text/javascript" src="/WeldStaffWeb/weldstaff/ajax.js"></script>
    <script type="text/javascript" src="/WeldStaffWeb/weldstaff/config.js"></script>
    <script type="text/javascript" src="/WeldStaffWeb/weldstaff/messager.js"></script>
    <script type="text/javascript" src="/WeldStaffWeb/weldstaff/initcombobox.js"></script>
    <style type="text/css">
        * {
            padding: 0px;
            margin: 0px;
        }
        
        .dialog-row {
            padding: 5px;
            align-items: baseline;
            vertical-align: middle;
        }
        
        .dialog-mask {
            position: fixed;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            background: #000;
            filter: alpha(opacity=50);
            opacity: .5;
            display: block;
            overflow-x: hidden;
            overflow-y: auto;
        }
        
        .dlg-tt {
            width: 750px;
            height: 450px;
            border: 1px solid #ddd;
            box-shadow: 0 3px 9px rgba(0, 0, 0, 0.5);
            border-radius: 4px;
            background-color: #fff;
            z-index: 11;
            display: none;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }
        
        .dlg-tt .dlg-title {
            font-size: 15px;
            line-height: 2;
            margin: 0 25px;
        }
        
        .dlg-tt .dlg-title a {
            float: right;
            color: red;
        }
        
        .dlg-tt .dlg-buttons {
            position: fixed;
            bottom: 15px;
            right: 15px;
        }
    </style>
</head>

<body>
    <div id="tb1">
        <span>船级社:<div id="船级社" style="width:150px"></div></span>
        <span>考试批次:<div id="考试批次" style="width:150px"></div></span>
        <span>结果:<div id="结果" style="width:150px"></div></span>
        <a href='#' class="easyui-linkbutton" onclick="insertUserByImport()">导入焊工模块</a>
    </div>
    <div style="overflow: auto">
        <div id="dbGrid"></div>
    </div>
 
</body>
<script type="text/javascript">
    var model = {
        run: function(call, url, param, callback) {
            call(url, param, function(res) {
                !res.state && $.messager.info("error", res.data);
                res.state && callback && callback(res);
            })
        },
        getBatch: function(param, callback) {
            model.run(AJAX.get, "/weldstaff/getrecord", param, callback);
        },
        get: function(param, callback) {
            model.run(AJAX.get, "/weldstaff/get", param, callback);
        },
        exportUserInfo:function(param, callback){
            model.run(AJAX.post,"/weldUserInfo/insertUserByImport",param, callback)
        }
    }
</script>
<script type="text/javascript">
    var User = {}
    var flagBtn = 0 //按钮的标识
        //初始化
    $(function() {
        //检测用户
        config.userCheck(function(user) {
            User = user
        })

        initConfigParams()
            //设置今天
        var curr_time = new Date();
        var height = document.documentElement.clientHeight - 350;
        var columns = [{
            field: 'ck',
            checkbox: true
        }, {
            field: '_id',
            title: '序号',
            width: 10,
            align: 'center',
            hidden: true
        }, {
            field: '姓名',
            title: '姓名',
            width: 20,
            align: 'center',
            sortable: true
        }, {
            field: '身份证',
            title: '身份证',
            width: 30,
            align: 'center',
            sortable: true
        },{
            field: '船级社',
            title: '船级社',
            width: 10,
            align: 'center'
        },  {
            field: '工区',
            title: '所属工区',
            width: 20,
            align: 'center'
        }, {
            field: '施工队',
            title: '施工队',
            width: 20,
            align: 'center',
            sortable: true
        }, {
            field: '焊接方法1',
            title: '焊接方法1',
            width: 20,
            align: 'center',
            sortable: true
        }, {
            field: '焊接方法2',
            title: '焊接方法2',
            width: 20,
            align: 'center',
            sortable: true
        }, {
            field: '试件形式',
            title: '试件形式',
            width: 20,
            align: 'center',
            sortable: true
        }, {
            field: '考试日期',
            title: '考试日期',
            width: 20,
            align: 'center'
        }, {
            field: '考试批次2',
            title: '考试批次',
            width: 15,
            align: 'center'
        }, {
            field: '外观检查',
            title: '外观检查',
            width: 20,
            align: 'center'
        }, {
            field: 'RT检查',
            title: 'RT检查',
            width: 20,
            align: 'center'
        }, {
            field: '结果',
            title: '结果',
            width: 20,
            align: 'center'
        }, {
            field: '合格位置',
            title: '合格位置',
            width: 20,
            align: 'center'
        }];
       
        $('#dbGrid').datagrid({
            width: 1600,
            height: document.documentElement.clientHeight,
            method: 'GET',
            striped: true,
            fitColumns: true,
            singleSelect: false,
            rownumbers: true,
            pagination: false,
            nowrap: false,
            remoteSort: false,
            pageSize: 10,
            pageList: [10, 20, 50, 100, 150, 200],
            showFooter: true,
            toolbar: "#tb1",
            columns: [columns],
            onClickRow: function(rowIndex, rowData) {
                $(this).datagrid('unselectAll');
                $(this).datagrid('selectRow', rowIndex);
            },
            rowStyler: function(index, row) {
                if (row["发布"] == undefined || row["发布"] == false) {
                    return 'background-color:pink;color:blue;font-weight:bold;';
                }
            }
        });

        function loadExamBatch(shipClass){
            var filter1 = {"船级社":shipClass};
            model.getBatch({filter:filter1}, function(res) {
                if (res.state) {
                    res.data.sort(function(two, one) {
                        return two["考试批次"] > one["考试批次"] ? -1 : 1;
                    })

                    $('#考试批次').combobox("loadData",res.data.splice(0, 12));
                        
                }
            });
        }
        //初始化配置
        function initConfigParams() {
            //加载配置
            var loadinit = function(data) {
                loadCombobox1('船级社', data.船级社, shipClassFromArr,"");
                loadComboboxFromArray('结果', data.评定结果,"");

                $('#考试批次').combobox({
                    textField: '考试批次2',
                    valueField: '考试批次2',
                    label: '',
                    onChange: btnLoad
                });

                $("#船级社").combobox({
                    onSelect:function(data){
                        loadExamBatch(data.v);
                    }
                });

                $("#结果").combobox({
                    onChange:btnLoad
                });

                $("#结果").combobox("setValue","合格");
            }
            config.loadConfigParam(loadinit);
        }
 
    })

    //刷新
    function btnLoad() {
        var filter = {};
        var value = $('#考试批次').combobox("getValue");
        if(value == ""){
            return;
        }
        filter["考试批次2"] = value;

        var value2 = $('#结果').combobox("getValue");
        if(value2 != ""){
            filter["结果"] = value2;
        }
        
        filter["status"] = {
            "$ne": -1
        }

        // $('#dbGrid').datagrid("options").url = '/weldstaff/get?filter=' + sfilter;
        // $('#dbGrid').datagrid('load');
        model.get({filter:filter}, function(res) {
            if (res.state) {
                $('#dbGrid').datagrid('loadData', res.data);
            }
        });
         
    }
 
    function insertUserByImport() {
        var rows = $('#dbGrid').datagrid('getChecked');
        if(rows.length == 0){
            $.messager.info("error", "请选择数据行后,在点击按钮");
        }

        rows.forEach(function(cell){
            if(cell["结果"] != "合格"){
                return;
            }
            //如果已经发不过了
            if(cell["发布"] == true){
                return;
            }
            model.exportUserInfo(cell,function(res) {
                if (!res.state) {
                    return $.messager.info("error", "导入信息到焊工模块失败");
                }
                var selidx = $('#dbGrid').datagrid('getRowIndex', cell);
                console.log(selidx);
                console.log(cell);
                $("#dbGrid").datagrid("updateRow", {
                    index: selidx,
                    row: res.data
                });
            });
        });
 
    }

    
</script>

</html>