<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>测试-焊工管理-申请录入</title>
    <link rel="stylesheet" type="text/css" href="js/easyui-1.5.3/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="js/easyui-1.5.3/themes/icon.css">
    <script type="text/javascript" src="js/easyui-1.5.3/jquery.min.js"></script>
    <script type="text/javascript" src="js/easyui-1.5.3/jquery.easyui.min.js"></script>
   
    <style type="text/css">
        .dialog-row {
            padding: 5px;
            align-items: baseline;
            vertical-align: middle;
        }

        .dialog-mask {
            position: fixed;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            background: #000;
            filter: alpha(opacity=50);
            opacity: .5;
            display: block;
            overflow-x: hidden;
            overflow-y: auto; 
        }

        .dlg-tt {
            width: 750px;
            height: 450px;
            border: 1px solid #ddd;
            box-shadow: 0 3px 9px rgba(0, 0, 0, 0.5);
            border-radius: 4px;
            background-color: #fff;
            z-index: 11;
            display: none;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }

        .dlg-tt .dlg-title {
            font-size: 15px;
            line-height: 2;
            margin: 0 25px;
        }

        .dlg-tt .dlg-title a {
            float: right;
            color: red;
        }

        .dlg-tt .dlg-buttons {
            position: fixed;
            bottom: 15px;
            right: 15px;
        }
    </style>
</head>
<body>
<div id="tb">
    <a href='#' class="easyui-linkbutton" onclick="btnLoad()">刷新</a>
    <a href='#' class="easyui-linkbutton" onclick="btnShowDlg2()">上传</a>
    <a href='#' class="easyui-linkbutton" onclick="btnAdd()">添加</a>
    <a href='#' class="easyui-linkbutton" onclick="btnRemove()">删除</a>
    <a href='#' class="easyui-linkbutton" onclick="btnEdit()">编辑</a>
    <a href='#' class="easyui-linkbutton" onclick="btnBook()">登记</a>
    |&nbsp;<a href='#' class="easyui-linkbutton" onclick="btnAdd2()">取消项复检</a>
    <a href='#' class="easyui-linkbutton" onclick="btnAdd3()">意见项复检</a>
    <span>上传日期:<input id="selDate" class="easyui-datebox" labelPosition="top" style="width:100px;"
                      data-options="formatter:config.myformatter,parser:config.myparser,onSelect:onChangeDate"></span>
    登记人:
    <div id="uploader" style="width:150px"></div>
</div>
<div>
    <div id="dbGrid"></div>
</div>

<div id="dlg" class="easyui-dialog" title="编辑对话框" style="width:400px;height:500px;padding:0px"
     data-options="iconCls:'icon-edit',
                     resizable:true,
                    modal:true,
                    closed:true,
                    buttons: '#dlg-buttons'">
    <form id="addNewForm">
    <div class="dialog-row">
        <div required="true" id="shipno" style="width:95%"></div>
    </div>
    <div class="dialog-row">
        <input class="easyui-textbox" id="name" style="width:95%" data-options="label:'姓名:'">
    </div>
    <div class="dialog-row">
        <input class="easyui-textbox" id="userid" style="width:95%" data-options="label:'身份证:'">
    </div>
    <div class="dialog-row">
        <input class="easyui-textbox" id="sex" style="width:95%" data-options="label:'性别:'">
    </div>
    <div class="dialog-row">
        <input class="easyui-textbox" id="examplace" style="width:95%" data-options="label:'考试位置:'">
    </div>
    <div class="dialog-row">
       <input class="easyui-textbox" id="workshop" style="width:95%" data-options="label:'所属工区:'">
    </div>
    <div class="dialog-row">
        <input class="easyui-textbox" id="workteam" style="width:95%" data-options="label:'施工队:'">
    </div>
    <div class="dialog-row">
        <input class="easyui-textbox" id="weldmethod1" style="width:95%" data-options="label:'焊接方法1:'">
    </div>
    <div class="dialog-row">
        <input class="easyui-textbox" id="weldmethod2" style="width:95%" data-options="label:'焊接方法2:'">
    </div>
    <div class="dialog-row">
        <input class="easyui-textbox" id="examtype" style="width:95%" data-options="label:'试件形式:'">
    </div>
    <div class="dialog-row">
        <input class="easyui-textbox" id="plathickness" style="width:95%" data-options="label:'板厚:'">
    </div>
    <div class="dialog-row">
        <input class="easyui-textbox" id="pipethickness" style="width:95%" data-options="label:'管壁厚度:'">
    </div>
    <div class="dialog-row">
        <input class="easyui-textbox" id="pipdiameter" style="width:95%" data-options="label:'管子外径:'">
    </div>
</div>
<div id="dlg-buttons">
    <a href="javascript:void(0)" class="easyui-linkbutton" onclick="btnEditOk()">&nbsp;Save&nbsp;</a>
    <a href="javascript:void(0)" class="easyui-linkbutton" onclick="javascript:$('#dlg').dialog('close')">Close</a>
</div>
</form>
<div id="dlg2" class="easyui-dialog" title="上传" style="width:400px;height:100px;padding:10px"
     data-options="iconCls:'icon-edit',
                     resizable:true,
                    modal:true,
                    closed:true">
    <form id="imgForm" method="post" enctype="multipart/form-data">
        <div>上传报验表</div>
        <input id="fileImg" name="file" class="easyui-filebox"
               data-options="buttonText:'选择表格',accept:'.xls'"/>
        <a href='#' class="easyui-linkbutton" onclick="btnUpload()">上传</a>
        <a href="templates/template_uploader.xls" style="float: right;">下载上传模板</a>
    </form>
</div>
<div id="dlg3" class="easyui-dialog" title="批量登记" style="width:400px;height:400px;padding:0px"
     data-options="iconCls:'icon-edit',
                     resizable:true,
                    modal:true,
                    closed:true,
                    buttons: '#dlg-buttons3'">
    <div class="dialog-row">
        <input class="easyui-textbox" id="booktime" style="width:85%" data-options="label:'报验日期:'">
        <input type="checkbox" id='cbbooktime'/>
    </div>
    <div class="dialog-row">
        <input class="easyui-textbox" id="booktime2" style="width:85%" data-options="label:'报验时间:'">
        <input type="checkbox" id='cbbooktime2'/>
    </div>
    <div class="dialog-row">
        <div id="bookplace" style="width:85%"></div>
        <input type="checkbox" id='cbbookplace'/>
    </div>
    <div class="dialog-row">
        <div id="bookwork" style="width:85%"></div>
        <input type="checkbox" id='cbbookwork'/>
    </div>
    <div class="dialog-row">
        <div id="bookchecker" style="width:85%"></div>
        <input type="checkbox" id='cbbookchecker'/>
    </div>
</div>
<div id="dlg-buttons3">
    <a href="javascript:void(0)" class="easyui-linkbutton" onclick="btnBookOk()">&nbsp;登记&nbsp;</a>
    <a href="javascript:void(0)" class="easyui-linkbutton" onclick="javascript:$('#dlg3').dialog('close')">Close</a>
</div>
<div id="dlg4" class="dlg-tt easyui-panel" style="width:750px;height:450px;overflow:hidden;">
    <div class="dlg-title">
        <span>取消项复检</span>
        <a href="javascript:void(0)" onclick="javascript:$('#dlg4').hide()">Close</a>
    </div>
    <div style="overflow:scroll;width:100%;">
        <div id="dbGrid4"></div>
    </div>
    <div class="dlg-buttons">
        <a href="javascript:void(0)" class="easyui-linkbutton" onclick="btnBookOk2()">&nbsp;登记&nbsp;</a>
        <a href="javascript:void(0)" class="easyui-linkbutton" onclick="javascript:$('#dlg4').hide()">Close</a>
    </div>
</div>
</body>
<script type="text/javascript">
      
    function btnShowDlg2() {
        $('#dlg2').dialog('open')
    }
    //上传每日报验表
    function btnUpload() {
        $("#imgForm").form('submit', {
            url: '/upload/n',
            data: $("#imgForm").serialize(),
            onSubmit: function (param) {
                param.user = "LZT"
                param.type = 3
                return true
            },
            success: function (datas) {
                items = JSON.parse(datas)
                console.log(items)
                
            }
        });
        $('#dlg2').dialog('close')
    }

    //编辑现有的行
    function btnEdit() {
        var row = $('#dbGrid').datagrid('getSelected')
        //console.log(row)
        $("#shipno").textbox("setValue", row.船号)
        $('#shipno').textbox('disable');
        $("#checktime").datebox("setValue", row.报验日期)
        $("#checktime2").textbox("setValue", row.报验时间)
        $("#checkplace").combobox("setValue", row.报验地点)
        $("#checknum").textbox("setValue", row.报验编号)
        // $('#checknum').textbox('textbox').attr('readonly',true);
        $('#checknum').textbox('disable');
        $("#checkitem").textbox("setValue", row.报验项目)
        $("#checkwork").combobox("setValue", row.报验工区)
        if (row.船东 == "*") {
            $("#owner").switchbutton('check');
        } else {
            $("#owner").switchbutton('uncheck');
        }

        if (row.船检 == "*") {
            $("#survey").switchbutton('check');
        } else {
            $("#survey").switchbutton('uncheck');
        }
        $("#checker").combobox("setValue", row.质检员)
        $("#major").combobox("setValue", row.报验专业)
        $('#major').combobox('disable');
        //
        flagBtn = 2;
        $('#dlg').dialog({title: "编辑"})
        $('#dlg').dialog('open')
    }
    //添加新的行
    function btnEditOk() {
        if(!$("#addNewForm").form('validate')){
            return $.messager.alert("提示","红色显示为必填项,存在必填项未填写,请核实");
        }
        var newObj = {}
        newObj.船号 = $("#shipno").combobox("getValue")
        newObj.报验日期 = $("#checktime").datebox("getValue")
        newObj.报验时间 = $("#checktime2").textbox("getValue")
        newObj.报验地点 = $("#checkplace").combobox("getValue")
        newObj.报验编号 = $("#checknum").textbox("getValue")
        newObj.报验项目 = $("#checkitem").textbox("getValue")
        newObj.报验工区 = $("#checkwork").combobox("getValue")
        if ($("#owner").switchbutton("options").checked) {
            newObj.船东 = '*'
        } else {
            newObj.船东 = ''
        }
        if ($("#survey").switchbutton("options").checked) {
            newObj.船检 = '*'
        } else {
            newObj.船检 = ''
        }
        newObj.质检员 = $("#checker").combobox("getValue")
        newObj.报验专业 = $("#major").combobox("getValue")
        newObj.登记人 = User['英文名']
        if (flagBtn == 2) {
            //更新行
            var selRow = $('#dbGrid').datagrid('getSelected')
            var selidx = $('#dbGrid').datagrid('getRowIndex', selRow)
            newObj._id = selRow._id
            newObj["更新用户"] = User.英文名
            var sparam = {data: JSON.stringify(newObj)}
            //更新
            doOnWeb('/dform/update/n', sparam, function (res) {
                if (parseInt(res) === 0) {
                    alert("保存失败")
                } else {
                    $("#dbGrid").datagrid("updateRow", {
                        index: selidx, //行索引
                        row: {
                            船号: res.船号,
                            报验日期: res.报验日期,
                            报验时间: res.报验时间,
                            报验地点: res.报验地点,
                            报验编号: res.报验编号,
                            报验项目: res.报验项目,
                            报验工区: res.报验工区,
                            船东: res.船东,
                            船检: res.船检,
                            质检员: res.质检员
                        }
                    })
                }
            })
        } else if (flagBtn == 1) {
            newObj["登记人"] = User.英文名
            var sparam = {data: JSON.stringify(newObj)}
            //添加
            doOnWeb('/dform/insert/n', sparam, function (res) {
                if (parseInt(res) === 0) {
                    alert("保存失败")
                } else {
                    //更新行
                    $("#dbGrid").datagrid("appendRow", res)
                }
            })
        }

        //关闭对话框
        $('#dlg').dialog('close')
    }

    //添加
    function btnAdd() {
        $('#checknum').textbox('disable');
        $('#major').combobox('enable');
        //打开对话框
        flagBtn = 1
        $('#dlg').dialog({title: "新加"});
        $('#dlg').dialog('open');
        $("#checker").combobox("setValue", User.英文名);
    }

    //删除
    function btnRemove() {
        $.messager.confirm('提示框', '你确定要删除吗?', function () {
            var rows = $('#dbGrid').datagrid('getChecked')
            for (var i = 0, len = rows.length; i < len; i++) {
                var selRow = rows[i]
                var selIdx = $('#dbGrid').datagrid('getRowIndex', selRow);
                var newObj = {}
                newObj._id = selRow._id
                newObj.报验编号 = selRow.报验编号
                newObj.船号 = selRow.船号
                newObj.状态 = 0
                var sparam = {data: JSON.stringify(newObj)}
                doOnWeb('/dform/delete/n', sparam, function (res) {
                    if (res.状态 == 0) {
                        $('#dbGrid').datagrid('deleteRow', selIdx);
                    }
                    if (res.状态2 == 0) {
                        $('#dbGrid').datagrid('deleteRow', selIdx);
                    }
                })
            }
        })
    }

    //登记
    function btnBook() {
        $('#dlg3').dialog('open')
    }

    //批量更新报验数据信息
    function btnBookOk() {
        var newObj = {};

        function getFilter(newObj) {

            if ($('#cbbooktime').prop('checked')) {
                newObj.报验日期 = $("#booktime").textbox("getValue")
            }
            if ($('#cbbooktime2').prop('checked')) {
                newObj.报验时间 = $("#booktime2").textbox("getValue")
            }
            if ($('#cbbookplace').prop('checked')) {
                newObj.报验地点 = $("#bookplace").combobox("getValue")
            }
            if ($('#cbbookwork').prop('checked')) {
                newObj.报验工区 = $("#bookwork").combobox("getValue")
            }
            if ($('#cbbookchecker').prop('checked')) {
                newObj.质检员 = $("#bookchecker").combobox("getValue")
            }
        }

        var rows = $('#dbGrid').datagrid('getChecked');
        if (rows.length <= 0) {
            return alert("请选择条目,在登记")
        }
        getFilter(newObj);

        for (var i = 0, len = rows.length; i < len; i++) {
            var selRow = rows[i];
            var selidx = $('#dbGrid').datagrid('getRowIndex', selRow);
            newObj._id = selRow._id;
            newObj.报验编号 = selRow.报验编号;
            newObj.船号 = selRow.船号;
            newObj["更新用户"] = User.英文名;
            //更新
            var sparam = {data: JSON.stringify(newObj)}
            doOnWeb('/dform/update/n', sparam, function (res) {
                if (parseInt(res) === 0) {
                    alert("保存失败")
                } else {
                    $("#dbGrid").datagrid("updateRow", {
                        index: selidx,
                        row: newObj
                    })
                }
            })
        }
        //关闭对话框
        $('#dlg3').dialog('close')
    }

    //加载取消项
    function btnAdd2() {
        //船东取消,船检取消,船厂取消,不可抗拒取消.
        var filter = {"状态": 50}
        sfilter = JSON.stringify(filter)

        $('#dbGrid4').datagrid("options").url = '/dform/get/n?filter=' + sfilter
        $('#dbGrid4').datagrid('load')

        $('#dlg4 .dlg-title span').text("取消项复检");
        $('#dlg4').show();
    }
    //更新报验后 需要复验的项目的状态,用户再次进行提交报验
    function btnBookOk2() {
        var rows = $('#dbGrid4').datagrid('getChecked')
        for (var i = 0, len = rows.length; i < len; i++) {
            var newObj = {}
            newObj._id = rows[i]._id
            newObj.报验编号 = rows[i].报验编号
            newObj.状态2 = rows[i].状态
            newObj.状态 = 1
            newObj.date1 = config.myformatter(new Date())
            newObj["更新用户"] = User.英文名
            console.log(newObj)
            //更新
            var sparam = {data: JSON.stringify(newObj)}
            doOnWeb('/dform/update/n', sparam, function (res) {
                if (parseInt(res) === 0) {
                    alert("保存失败")
                } else {
                    $("#dbGrid").datagrid("appendRow", res)
                }
            })
        }
        //关闭对话框
        $('#dlg4').hide()
    }

    //加载取消项
    function btnAdd3() {
        //录入项,C 有遗留问题需复验,D 拒绝
        var filter = {"状态": 40};
        sfilter = JSON.stringify(filter)

        $('#dbGrid4').datagrid("options").url = '/dform/get/n?filter=' + sfilter
        $('#dbGrid4').datagrid('load')

        $('#dlg4 .dlg-title span').text("意见项复检");
        $('#dlg4').show()
    }

    //sparam对象 cb处理函数
    function doOnWeb(surl, sparam, cb) {
        $.ajax({
            url: surl,
            async: false,
            data: sparam,
            success: function (res, status) {
                typeof cb == 'function' && cb(res)
            },
            //调用出错执行的函数
            error: function () {
                //请求出错处理
                alert("出错")
            }
        })
    }

</script>
</html>